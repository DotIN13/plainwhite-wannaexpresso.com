<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="google-site-verification" content="zrVlHARQzSGPX8n0jKJdP_fCO0AvtLXxoPmYkJh-oXw"/><meta name="description" content="Act local, think global with DotIN13!"><meta name="keywords" content="Apple Silicon, MacBook, SSHFS, SFTP, Linux, and macFUSE"><meta name="theme-color" content="#ff94c2"><meta lang="zh"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png?v=2bA3g2vyYK"><link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg?v=2bA3g2vyYK" color="#dc2267"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico?v=2bA3g2vyYK"><meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml?v=2bA3g2vyYK"><meta property="og:title" content="在M1 Macbook上使用SSHFS挂载SFTP协议文件系统 - DOTIN13'S BLOG"><meta property="og:type" content="article"><meta property="og:description" content="无中生有的需求 - 其实我并不怎么看电影。 - ……好吧，我承认，偶尔想看……又或许只是喜欢拥有的感觉罢了。 欲望，总是在无边无际地扩张。“不得已”买了Raspberry Pi，向辣爸讨了块3TB机械，也算入了NAS的门。 过去用着Manjaro+Windows，可以直接在Gnome Nautilus中挂载树莓派的SFTP服务器，双击视频就可以通过Celluloid播放。然而这在ma..."><meta property="article:published_time" content="2021-03-12T00:00:00Z"><meta property="article:author" content="DotIN13"><meta property="article:tag" content="Apple Silicon"><meta property="article:tag" content="MacBook"><meta property="article:tag" content="SSHFS"><meta property="article:tag" content="SFTP"><meta property="article:tag" content="Linux"><meta property="article:tag" content="macFUSE"><meta property="og:image" content="https://www.wannaexpresso.com/assets/img/orange.webp"><meta property="og:url" content="https://www.wannaexpresso.com/2021/03/12/m1-macbook-sshfs/"><meta property="og:site_name" content="DOTIN13'S BLOG"><link rel="canonical" href="https://www.wannaexpresso.com/2021/03/12/m1-macbook-sshfs/"><script src="/assets/public/application-bundle.js"></script><link rel="stylesheet" href="/assets/public/application.css"><script src="/assets/public/posts-bundle.js"></script><title>在M1 Macbook上使用SSHFS挂载SFTP协议文件系统 - DOTIN13'S BLOG</title></head><body><main class="container"><section class="about"><div class="about-header"><div class="about-title"><a href="/" id="avatar" data-caption="DotIN13" data-webpack="true" data-path="/assets/img/orange.webp"></a><h2 id="title"><a href="/">DotIN13</a></h2></div><p class="tagline">LACKAWANNA<br>EXPRESSO</p></div><div class="buttons"><a href="/en-us/" class="language-selection button icon-translate" aria-label="Change locale to English."></a><a href="/feed.xml" class="feed button icon-rss_feed" aria-label="RSS Feed"></a><input type="checkbox" class="dark-mode-toggle" aria-label="dark-mode-switch"><a href="#" aria-label="Click to toggle darkmode." class="button"><span class="icon-moon"></span><span class="icon-sun"></span></a><a href="#" id="pwa-install" class="install button icon-install disabled" aria-label="Install as Web Application"><span>Install</span></a></div><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></section><section class="content"><div class="post-container"><a class="post-link" href="/2021/03/12/m1-macbook-sshfs/"><h2 class="post-title">在M1 Macbook上使用SSHFS挂载SFTP协议文件系统</h2><h3 class="post-subtitle">Mounting SFTP Filesystem on M1 MacBook</h3></a><div class="post-meta"><div class="post-categories"><a class="button" href="/archive/?tag=Apple+Silicon" title="Apple Silicon">Apple Silicon</a><a class="button" href="/archive/?tag=MacBook" title="MacBook">MacBook</a><a class="button" href="/archive/?tag=SSHFS" title="SSHFS">SSHFS</a><a class="button" href="/archive/?tag=SFTP" title="SFTP">SFTP</a><a class="button" href="/archive/?tag=Linux" title="Linux">Linux</a><a class="button" href="/archive/?tag=macFUSE" title="macFUSE">macFUSE</a></div><div class="post-misc"><div class="post-date"><i class="icon-calendar"></i>Mar 12, 2021</div></div></div><div class="post"><h2 id="无中生有的需求"><a href="#无中生有的需求">#</a> 无中生有的需求 </h2><p>- 其实我并不怎么看电影。</p><p>- ……好吧，我承认，偶尔想看……又或许只是喜欢拥有的感觉罢了。</p><p>欲望，总是在无边无际地扩张。“不得已”买了Raspberry Pi，向辣爸讨了块3TB机械，也算入了NAS的门。</p><p>过去用着Manjaro+Windows，可以直接在<a href="https://gitlab.gnome.org/GNOME/nautilus" target="_blank" rel="nofollow noopener noreferrer">Gnome Nautilus</a>中挂载树莓派的SFTP服务器，双击视频就可以通过<a href="https://celluloid-player.github.io/" target="_blank" rel="nofollow noopener noreferrer">Celluloid</a>播放。然而这在macOS上似乎没有完美的解决方案，试用了<a href="https://cyberduck.io/" target="_blank" rel="nofollow noopener noreferrer">Cyberduck</a>、<a href="https://www.panic.com/transmit/" target="_blank" rel="nofollow noopener noreferrer">Tansmit</a>、<a href="https://electerm.github.io/electerm/" target="_blank" rel="nofollow noopener noreferrer">Electerm</a>，却发现统统不能做到Manjaro上那样丝滑的体验。最好的方案也只能用FileZilla右键获取<code class="language-plaintext highlighter-rouge">sftp://</code>地址后粘贴到VLC播放。</p><p>于是，目光转向歪门邪道——尝试挂载服务器到Finder。</p><h2 id="百无一用的折腾"><a href="#百无一用的折腾">#</a> 百无一用的折腾 </h2><p><a href="https://github.com/libfuse/sshfs" target="_blank" rel="nofollow noopener noreferrer">SSHFS</a>似乎是我能找到的唯一挂载方案。</p><h3 id="安装macfuse"><a href="#安装macfuse">#</a> 安装macFUSE </h3><p>从官网下载<a href="https://github.com/osxfuse/osxfuse/releases/download/macfuse-4.0.5/macfuse-4.0.5.dmg" target="_blank" rel="nofollow noopener noreferrer">macFUSE 4.0.5</a>，直接打开<code class="language-plaintext highlighter-rouge">.dmg</code>文件安装。安装完成后不出意外需要重启macOS。</p><h3 id="安装编译依赖"><a href="#安装编译依赖">#</a> 安装编译依赖 </h3><p>老规矩，用<code class="language-plaintext highlighter-rouge">homebrew</code>安装依赖最为简便快捷。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install Apple Development Tools</span>
xcode-select <span class="nt">--install</span>
<span class="c"># Install Homebrew</span>
/bin/bash <span class="nt">-c</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span class="si">)</span><span class="s2">"</span>
</code></pre></div></div><p>然后安装必须的依赖，包括python与glib。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>python@3.9
brew <span class="nb">install </span>glib
</code></pre></div></div><h3 id="下载并修改sshfs源码"><a href="#下载并修改sshfs源码">#</a> 下载并修改SSHFS源码 </h3><p>由于最新版的SSHFS 3.7.1并不支持macOS，因此需要从<code class="language-plaintext highlighter-rouge">GitHub</code>的<a href="https://github.com/libfuse/sshfs/releases/tag/sshfs-2.10" target="_blank" rel="nofollow noopener noreferrer">Repo</a>下载<a href="https://github.com/libfuse/sshfs/releases/download/sshfs-2.10/sshfs-2.10.tar.gz" target="_blank" rel="nofollow noopener noreferrer">2.10版本的源码</a>。</p><p>解压后，根据<a href="https://github.com/osxfuse/sshfs/pull/58" target="_blank" rel="nofollow noopener noreferrer">Pull Request #58</a>的提示，找到<code class="language-plaintext highlighter-rouge">#1724</code>行，修改<code class="language-plaintext highlighter-rouge">sshfs.sync_read</code>为0。</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Force async even if kernel claims its doing async.</span>
<span class="c1">// MacOS, see https://github.com/osxfuse/sshfs/issues/57</span>
<span class="n">sshfs</span><span class="p">.</span><span class="n">sync_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div><p>然后，修改<code class="language-plaintext highlighter-rouge">#18</code>行的<code class="language-plaintext highlighter-rouge"># include &lt;fuse_darwin.h&gt;</code>为<code class="language-plaintext highlighter-rouge">#include &lt;fuse.h&gt;</code>。</p><h3 id="编译"><a href="#编译">#</a> 编译 </h3><p>参照<a href="https://github.com/osxfuse/sshfs#installing" target="_blank" rel="nofollow noopener noreferrer">SSHFS编译指南</a>进行编译。首先<code class="language-plaintext highlighter-rouge">cd</code>进入解压得到的<code class="language-plaintext highlighter-rouge">sshfs-2.10</code>文件夹，然后依次运行如下指令进行编译。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./configure
make
<span class="nb">sudo </span>make <span class="nb">install</span>
</code></pre></div></div><h3 id="运行"><a href="#运行">#</a> 运行 </h3><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sshfs <span class="o">[</span>user@]host:[dir] mountpoint <span class="o">[</span>options]
<span class="c"># sshfs [用户名@]服务器地址:[服务器路径] 本地挂载路径 [选项]</span>
</code></pre></div></div><p>初次挂载不成功，因为macFUSE需要向系统添加内核插件。macFUSE提示，要进入<code class="language-plaintext highlighter-rouge">系统设置-&gt;安全与隐私</code>（<code class="language-plaintext highlighter-rouge">System Preferences -&gt; Security and Privicy</code>）关闭系统安全机制，才能够正确加载挂载所需的内核插件。</p><div class="post-img"><a href="/assets/img/in-post/post-macbook/system-ext.png" data-fancybox="gallery" data-caption="Prompt To Enable System Extentions" data-path="post-macbook/system-ext.png" data-webpack="true"></a><em>Prompt To Enable System Extentions</em></div><p>依照<a href="https://support.apple.com/zh-cn/guide/mac-help/mchl768f7291/11.0/mac/11.0" target="_blank" rel="nofollow noopener noreferrer">Apple官方指南</a>进入恢复模式进行修改。</p><ol><li><p>在搭载 Apple 芯片的 Mac 上，选取苹果<code class="language-plaintext highlighter-rouge">菜单-&gt;关机</code>。</p></li><li><p>按住电源按钮直至看到<code class="language-plaintext highlighter-rouge">正在载入启动选项</code>。</p></li><li><p>点按<code class="language-plaintext highlighter-rouge">选项</code>，然后点按<code class="language-plaintext highlighter-rouge">继续</code>。</p><p>如有要求，请输入管理员帐户的密码。</p><p>Mac 将以恢复模式（Recovery Mode）打开。</p></li><li><p>在<code class="language-plaintext highlighter-rouge">macOS 恢复</code>中，选取<code class="language-plaintext highlighter-rouge">实用工具-&gt;启动安全性实用工具</code>（Startup Security Utilities）。</p></li><li><p>选择要用于设定安全策略的启动磁盘。</p><p>如果磁盘已使用文件保险箱加密，请点按<code class="language-plaintext highlighter-rouge">解锁</code>，输入密码，然后点按<code class="language-plaintext highlighter-rouge">解锁</code>。</p></li><li><p>点按<code class="language-plaintext highlighter-rouge">安全策略</code>（Security Policy）。</p></li><li><p>检查以下安全性选项：</p><ul><li><em>完整安全性：</em>确保只有当前的操作系统或者当前 Apple 信任的签名操作系统软件才能运行。此模式要求在安装软件时接入网络。</li><li><em>降低安全性：</em>允许运行 Apple 信任过的任何版本的签名操作系统软件。</li></ul></li><li><p>我们需要选择<code class="language-plaintext highlighter-rouge">降低安全性</code>来启用macFUSE，输入管理员用户名和密码：</p><ul><li>选择“允许用户管理来自被认可开发者的内核扩展”复选框以允许使用旧版内核扩展的软件进行安装。</li></ul></li><li><p>点按<code class="language-plaintext highlighter-rouge">好</code>，重新启动 Mac 以使更改生效。</p></li></ol><p>此时再进入<code class="language-plaintext highlighter-rouge">系统设置-&gt;安全与隐私</code>，发现下方已经多出了一个选项，选择后，可以运行任何来源的系统软件。再次运行<code class="language-plaintext highlighter-rouge">sshfs</code>命令，已经可以挂载。</p><h2 id="乏善可陈的疗效"><a href="#乏善可陈的疗效">#</a> 乏善可陈的疗效 </h2><p>然而，在我花了几个小时安装、挂载成功之后，竟觉食之无味，弃之可惜。</p><p>使用FileZilla可以达到30MB/s内网的传输速度，而挂载的SSHFS文件系统仅仅能达到数十KB/s，完全无法流畅串流视频。</p><p>不总是止步，不总是成功；不总是成功，不总是止步。</p></div><ul class="post-pager"><li class="pager--prev"><a class="button" href="/2021/02/20/m1-macbook-minecraft/" data-toggle="tooltip" data-placement="top" title="在M1 Macbook上不使用Rosetta优雅地游玩Minecraft+Forge"> PREV<br><span>在M1 Macbook上不使用Rosetta优雅地游玩Minecraft+Forge</span></a></li></ul><div id="vcomments"></div></div></section><footer class="about condensed"><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></footer></main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-159368053-1"></script><script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159368053-1');
    </script></body></html>