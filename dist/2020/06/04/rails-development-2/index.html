<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="google-site-verification" content="zrVlHARQzSGPX8n0jKJdP_fCO0AvtLXxoPmYkJh-oXw"/><meta name="description" content="Act local, think global with DotIN13!"><meta name="keywords" content="Linux, Ruby, Ruby on Rails, and WoD"><meta name="theme-color" content="#ff94c2"><meta lang="zh"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png?v=2bA3g2vyYK"><link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg?v=2bA3g2vyYK" color="#dc2267"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico?v=2bA3g2vyYK"><meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml?v=2bA3g2vyYK"><meta property="og:title" content="RoR开发日志二 - DOTIN13'S BLOG"><meta property="og:type" content="article"><meta property="og:description" content="数据库配置 在亚马逊香港区建立了自己的账户，新建了一个RDS实例，却发现免费套餐的t2.micro根本不在选项列表中，只得选择了最便宜的t3.micro。一问客服，却推说港区是新区，需要和当地团队确认，计费已经开始两天，至今还没有回复，每小时0.03美元的价格虽说不贵，却也终究是钱，如若不能解决，倒是可以回头尝试一下Oracle的Always Free。 以上是题外话，接下来谈谈在配置数..."><meta property="article:published_time" content="2020-06-04T00:00:00Z"><meta property="article:author" content="DotIN13"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Ruby"><meta property="article:tag" content="Ruby on Rails"><meta property="article:tag" content="WoD"><meta property="og:image" content="https://www.wannaexpresso.com/assets/img/orange.webp"><meta property="og:url" content="https://www.wannaexpresso.com/2020/06/04/rails-development-2/"><meta property="og:site_name" content="DOTIN13'S BLOG"><link rel="canonical" href="https://www.wannaexpresso.com/2020/06/04/rails-development-2/"><script src="/assets/public/application-bundle.js"></script><link rel="stylesheet" href="/assets/public/application.css"><script src="/assets/public/posts-bundle.js"></script><title>RoR开发日志二 - DOTIN13'S BLOG</title></head><body><main class="container"><section class="about"><div class="about-header"><div class="about-title"><a href="/" id="avatar" data-caption="DotIN13" data-webpack="true" data-path="/assets/img/orange.webp"></a><h2 id="title"><a href="/">DotIN13</a></h2></div><p class="tagline">LACKAWANNA<br>EXPRESSO</p></div><div class="buttons"><a href="/en-us/" class="language-selection button icon-translate" aria-label="Change locale to English."></a><a href="/feed.xml" class="feed button icon-rss_feed" aria-label="RSS Feed"></a><input type="checkbox" class="dark-mode-toggle" aria-label="dark-mode-switch"><a href="#" aria-label="Click to toggle darkmode." class="button"><span class="icon-moon"></span><span class="icon-sun"></span></a><a href="#" id="pwa-install" class="install button icon-install disabled" aria-label="Install as Web Application"><span>Install</span></a></div><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></section><section class="content"><div class="post-container"><a class="post-link" href="/2020/06/04/rails-development-2/"><h2 class="post-title">RoR开发日志二</h2><h3 class="post-subtitle">Ruby on Rails Development Log Two</h3></a><div class="post-meta"><div class="post-categories"><a class="button" href="/archive/?tag=Linux" title="Linux">Linux</a><a class="button" href="/archive/?tag=Ruby" title="Ruby">Ruby</a><a class="button" href="/archive/?tag=Ruby+on+Rails" title="Ruby on Rails">Ruby on Rails</a><a class="button" href="/archive/?tag=WoD" title="WoD">WoD</a></div><div class="post-misc"><div class="post-date"><i class="icon-calendar"></i>Jun 4, 2020</div></div></div><div class="post"><h2 id="数据库配置"><a href="#数据库配置">#</a> 数据库配置 </h2><p>在亚马逊香港区建立了自己的账户，新建了一个RDS实例，却发现免费套餐的t2.micro根本不在选项列表中，只得选择了最便宜的t3.micro。一问客服，却推说港区是新区，需要和当地团队确认，计费已经开始两天，至今还没有回复，每小时0.03美元的价格虽说不贵，却也终究是钱，如若不能解决，倒是可以回头尝试一下Oracle的Always Free。</p><p>以上是题外话，接下来谈谈在配置数据库的时候遇到的坑。</p><p>一个正确的<code class="language-plaintext highlighter-rouge">database.yml</code>配置是App成功调用RDS实例的必要条件。一开始我配置了<code class="language-plaintext highlighter-rouge">database</code>、<code class="language-plaintext highlighter-rouge">username</code>以及<code class="language-plaintext highlighter-rouge">password</code>和<code class="language-plaintext highlighter-rouge">host</code>，却发现程序虽然处于production中，却依旧在使用<code class="language-plaintext highlighter-rouge">sqlite3</code>作为数据库。</p><p>对照网络上的配置，发现少了两行，由于我的RDS是PostgreSQL，还需要额外配置<code class="language-plaintext highlighter-rouge">adapter</code>和<code class="language-plaintext highlighter-rouge">encoding</code>，否则Rails就会调用<code class="language-plaintext highlighter-rouge">database.yml</code>中的default设置，而default中指定的数据库类型是<code class="language-plaintext highlighter-rouge">sqlite3</code>。</p><p>一个正确的<code class="language-plaintext highlighter-rouge">database.yml</code>配置实例如下：</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/database.yml</span>
<span class="na">production</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="c1"># database: db/production.sqlite3</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">postgresql</span>
  <span class="na">encoding</span><span class="pi">:</span> <span class="s">unicode</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">&lt;%= ENV['RDS_DATABASE'] %&gt;</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">&lt;%= ENV['RDS_USERNAME'] %&gt;</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['RDS_PASSWORD'] %&gt;</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">&lt;%= ENV['RDS_HOST'] %&gt;</span>
  <span class="na">post</span><span class="pi">:</span> <span class="m">5432</span>
</code></pre></div></div><h2 id="环境变量"><a href="#环境变量">#</a> 环境变量 </h2><p>一开始我的环境变量用的是<code class="language-plaintext highlighter-rouge">~/.bashrc</code>，直接在文件中添加<code class="language-plaintext highlighter-rouge">export KEY=value</code>，然后<code class="language-plaintext highlighter-rouge">source ~/.bashrc</code>更新环境。但似乎Rails在读取这类环境变量时偶尔会出现不能读取的问题，并且网络上认为这种方式不够安全，于是我转而采用了dotenv gem，然而，在我第二次部署到服务器的时候，Rails就不能正确读取环境变量了，甚至环境变成了development。这种问题自然不能忍，于是又转而使用<a href="https://github.com/laserlemon/figaro" target="_blank" rel="nofollow noopener noreferrer">figaro gem</a>。</p><p>老规矩：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"figaro"</span>
</code></pre></div></div><p>执行：</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle <span class="nb">install
</span>bundle <span class="nb">exec </span>figaro <span class="nb">install</span>
</code></pre></div></div><p>figaro会修改<code class="language-plaintext highlighter-rouge">.gitignore</code>，并创建<code class="language-plaintext highlighter-rouge">config/application.yml</code>。修改<code class="language-plaintext highlighter-rouge">.gitignore</code>的本意就是不要将<code class="language-plaintext highlighter-rouge">application.yml</code>的敏感信息传输到git。因此我们需要在服务器上手工创建一个<code class="language-plaintext highlighter-rouge">application.yml</code>，并且将环境变量填入。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.yml</span>
<span class="na">production</span><span class="pi">:</span>
  <span class="na">RDS_DATABASE</span><span class="pi">:</span> <span class="s2">"</span><span class="s">postgresql://sadhuhuwd.aws.com/asdhuio"</span>
  <span class="na">RDS_PASSWORD</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ad69caf9a44dcac1fb28"</span>
  <span class="na">MAILER_EMAIL</span><span class="pi">:</span> <span class="s2">"</span><span class="s">83ca7aa160fedaf3b350@gmail.com"</span>
</code></pre></div></div><p>然后启动服务器，Rails就能够正确识别环境变量了。</p><h2 id="rails-credentials"><a href="#rails-credentials">#</a> Rails Credentials </h2><p>Rails 5.1+开始，不再使用<code class="language-plaintext highlighter-rouge">secret.yml</code>存储主密钥，而采用<code class="language-plaintext highlighter-rouge">config/credentials.yml.enc</code>存储加密后的主密钥，再由<code class="language-plaintext highlighter-rouge">config/master.key</code>存储解密密钥用于解密<code class="language-plaintext highlighter-rouge">credentials.yml.enc</code>，来确保密钥的安全。在production环境中如果Rails找不到解密密钥，就可能出现以下的错误。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Possible Error 1</span>
ActiveSupport::MessageEncryptor::InvalidMessage
<span class="c"># Possible Error 2</span>
Please run <span class="sb">`</span>rails credentials:edit<span class="sb">`</span>
</code></pre></div></div><p>这一问题困扰了我几乎一整天，我每次尝试向Elastic Beanstalk部署都以失败告终。最后发现，<a href="https://stackoverflow.com/questions/60466861/how-to-generate-a-missing-secret-key-base-on-aws" target="_blank" rel="nofollow noopener noreferrer">StackOverflow的littleforest</a>回答了这一问题，有两种解决方案。</p><h3 id="方案一"><a href="#方案一">#</a> 方案一 </h3><p>在本地环境运行：</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails credentials:edit
</code></pre></div></div><p>复制出现的secret_base_key，在你的服务器环境变量中添加<code class="language-plaintext highlighter-rouge">SECRET_KEY_BASE=&lt;你刚才复制的内容&gt;</code></p><h3 id="方案二"><a href="#方案二">#</a> 方案二 </h3><p>我最终选择了这一解决方案。</p><p>在本地环境运行：</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails credentials:edit
</code></pre></div></div><p>然后打开<code class="language-plaintext highlighter-rouge">config/master.key</code>，复制内容。</p><p>在服务器的环境变量中添加<code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY=&lt;你刚才复制的内容&gt;</code></p><p>最后还是推荐使用刚刚提到的figaro gem来管理ENV。</p><h2 id="webpacker-compiling"><a href="#webpacker-compiling">#</a> Webpacker Compiling </h2><p>使用Asset Pipeline的时候遇到一个问题，那就是不能保证scss文件按顺序加载。这导致了在多文件中调用bootstrap变量100%报错。既然Webpacker是大势所趋，我也勉为其难<a href="https://www.vic-l.com/setup-bootstrap-in-rails-6-with-webpacker-for-development-and-production/" target="_blank" rel="nofollow noopener noreferrer">依照教程</a>将scss放到了<code class="language-plaintext highlighter-rouge">app/javascript/stylesheets</code>，使用<code class="language-plaintext highlighter-rouge">application.js</code>来加载scss。</p><p>然而打开rails server，进入网页却收到错误，大体如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>could not find application in manifest.json
</code></pre></div></div><p>这就涉及到我的知识盲区了，搜集资料后发现Webpack顾名思义，是有一个pack过程的，Webpacker将资源文件打包之后，默认保存在<code class="language-plaintext highlighter-rouge">app/public/packs</code>文件夹中，并生成一个<code class="language-plaintext highlighter-rouge">manifest.json</code>来为Rails指明需要加载<code class="language-plaintext highlighter-rouge">packs</code>文件夹中的哪些文件，由于我们没有设置Webpacker编译css，在manifest中Rails是找不到css文件的索引的。因此需要在<code class="language-plaintext highlighter-rouge">config/webpacker.yml</code>中进行配置。</p><p>在defaults和development项目中进行如下配置：</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/webpacker.yml</span>
<span class="na">default</span><span class="pi">:</span> <span class="nl">&amp;default</span>

  <span class="s">...</span>
  
  <span class="s"># Reload manifest.json on all requests so we reload latest compiled packs</span>
  <span class="s">cache_manifest</span><span class="pi">:</span> <span class="no">false</span>

  <span class="c1"># Extract and emit a css file</span>
  <span class="na">extract_css</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="s">...</span>
  
<span class="na">development</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="na">compile</span><span class="pi">:</span> <span class="no">true</span>
  
  <span class="s">...</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">extract_css</code>保证了Webpacker会生成编译好的css，<code class="language-plaintext highlighter-rouge">compile</code>表示在开始服务器前进行编译，而<code class="language-plaintext highlighter-rouge">cache_manifest</code>则让我折腾了好几个小时，不小心将它设置成true导致了每次修改css网页都不会更新，因此需要格外小心，保证其设置为false。</p><p>在开发的时候，可以使用命令<code class="language-plaintext highlighter-rouge">bin/webpack-dev-server</code>打开编译服务器，Webpacker会检测资源文件的改动，并且即时生成<code class="language-plaintext highlighter-rouge">manifest.json</code>。更贴心的是，它还能够自动刷新浏览器以应用改动。</p><h2 id="本地预编译"><a href="#本地预编译">#</a> 本地预编译 </h2><p>在将App部署到EC2的过程当中，发现<code class="language-plaintext highlighter-rouge">rails server</code>命令本身不会预编译资源文件，需要额外运行<code class="language-plaintext highlighter-rouge">rails assets:precompile</code>，然而，1G1C的服务器运行预编译半个小时都不能完成，于是只得考虑在本地编译。</p><p>在本地运行<code class="language-plaintext highlighter-rouge">rails assets:precompile</code>之后，在<code class="language-plaintext highlighter-rouge">.gitignore</code>中删除或者comment以下路径：</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /public/packs</span>
</code></pre></div></div><p>这样push时就能将预编译的文件一并上传了。</p><blockquote><p>20200608#EDIT: 重新建立EC2实例后，发现只要打开实例的Unlimited特性，服务器就能够应对突增的性能需求了，编译只需要数分钟，因此我不再需要本地预编译。</p></blockquote></div><ul class="post-pager"><li class="pager--next"><a class="button" href="/2020/06/06/rails-development-3/" data-toggle="tooltip" data-placement="top" title="RoR开发日志三 Capistrano + Puma + Caddy部署特辑"> NEXT<br><span>RoR开发日志三 Capistrano + Puma + Caddy部署特辑</span></a></li><li class="pager--prev"><a class="button" href="/2020/05/30/rails-development-1/" data-toggle="tooltip" data-placement="top" title="RoR开发日志一"> PREV<br><span>RoR开发日志一</span></a></li></ul><div id="vcomments"></div></div></section><footer class="about condensed"><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></footer></main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-159368053-1"></script><script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159368053-1');
    </script></body></html>