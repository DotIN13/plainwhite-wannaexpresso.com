<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="google-site-verification" content="zrVlHARQzSGPX8n0jKJdP_fCO0AvtLXxoPmYkJh-oXw"/><meta name="description" content="Act local, think global with DotIN13!"><meta name="keywords" content="WoD, Caddy, and Reverse Proxy"><meta name="theme-color" content="#ff94c2"><meta lang="zh"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png?v=2bA3g2vyYK"><link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg?v=2bA3g2vyYK" color="#dc2267"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico?v=2bA3g2vyYK"><meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml?v=2bA3g2vyYK"><meta property="og:title" content="用Caddy2反向代理地下城世界 - DOTIN13'S BLOG"><meta property="og:type" content="article"><meta property="og:description" content="Caddy 2 之前已经利用Caddy 2尝试了搭建Aria2下载站，不过没有好好介绍，这里就再唠叨几句，谈谈Caddy 2的优点。 安装简单到令人发指。 Caddy 2将整个程序封装为了一个二进制文件，安装就是直接把caddy文件拷贝到/usr/bin，卸载就是删除，更新就是替换，方便到一种境界了。 Caddy是唯一一个自动支持HTTPS的网站服务器。 只要你告诉Caddy ..."><meta property="article:published_time" content="2020-04-26T00:00:00Z"><meta property="article:author" content="DotIN13"><meta property="article:tag" content="WoD"><meta property="article:tag" content="Caddy"><meta property="article:tag" content="Reverse Proxy"><meta property="og:image" content="https://www.wannaexpresso.com/assets/img/orange.webp"><meta property="og:url" content="https://www.wannaexpresso.com/2020/04/26/wod-reverse-proxy/"><meta property="og:site_name" content="DOTIN13'S BLOG"><link rel="canonical" href="https://www.wannaexpresso.com/2020/04/26/wod-reverse-proxy/"><script src="/assets/public/application-bundle.js"></script><link rel="stylesheet" href="/assets/public/application.css"><script src="/assets/public/posts-bundle.js"></script><title>用Caddy2反向代理地下城世界 - DOTIN13'S BLOG</title></head><body><main class="container"><section class="about"><div class="about-header"><div class="about-title"><a href="/" id="avatar" data-caption="DotIN13" data-webpack="true" data-path="/assets/img/orange.webp"></a><h2 id="title"><a href="/">DotIN13</a></h2></div><p class="tagline">LACKAWANNA<br>EXPRESSO</p></div><div class="buttons"><a href="/en-us/" class="language-selection button icon-translate" aria-label="Change locale to English."></a><a href="/feed.xml" class="feed button icon-rss_feed" aria-label="RSS Feed"></a><input type="checkbox" class="dark-mode-toggle" aria-label="dark-mode-switch"><a href="#" aria-label="Click to toggle darkmode." class="button"><span class="icon-moon"></span><span class="icon-sun"></span></a><a href="#" id="pwa-install" class="install button icon-install disabled" aria-label="Install as Web Application"><span>Install</span></a></div><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></section><section class="content"><div class="post-container"><a class="post-link" href="/2020/04/26/wod-reverse-proxy/"><h2 class="post-title">用Caddy2反向代理地下城世界</h2><h3 class="post-subtitle">Reverse Proxy World of Dungeons with Caddy 2</h3></a><div class="post-meta"><div class="post-categories"><a class="button" href="/archive/?tag=WoD" title="WoD">WoD</a><a class="button" href="/archive/?tag=Caddy" title="Caddy">Caddy</a><a class="button" href="/archive/?tag=Reverse+Proxy" title="Reverse Proxy">Reverse Proxy</a></div><div class="post-misc"><div class="post-date"><i class="icon-calendar"></i>Apr 26, 2020</div></div></div><div class="post"><h2 id="caddy-2"><a href="#caddy-2">#</a> Caddy 2 </h2><p>之前已经利用Caddy 2尝试了搭建Aria2下载站，不过没有好好介绍，这里就再唠叨几句，谈谈Caddy 2的优点。</p><ol><li>安装简单到令人发指。 Caddy 2将整个程序封装为了一个二进制文件，安装就是直接把<code class="language-plaintext highlighter-rouge">caddy</code>文件拷贝到<code class="language-plaintext highlighter-rouge">/usr/bin</code>，卸载就是删除，更新就是替换，方便到一种境界了。</li><li>Caddy是唯一一个自动支持HTTPS的网站服务器。 只要你告诉Caddy 2你要部署的域名或者IP，Caddy就会自动签发自签证书或者Let’s Encrypt证书，并且自动将80端口的访问重定向到443端口，免去了大量设置过程。</li><li>功能丰富。 你可以利用Caddy 2的<code class="language-plaintext highlighter-rouge">file_server</code>搭建静态网站，用<code class="language-plaintext highlighter-rouge"> file_server browse</code>搭建文件分享站，用<code class="language-plaintext highlighter-rouge">reverse_proxy</code>搭建反向代理，甚至直接让Caddy帮你渲染<code class="language-plaintext highlighter-rouge">.md</code>文件搭建博客。</li><li>配置简单。 Caddy从第一代开始就提供简单易学的Caddyfile配置方式，用JSON数十行才能搞定的配置，在Caddyfile里可能只需要寥寥几行。当然，它也同时支持JSON配置来完成复杂的工作。</li></ol><h2 id="反向代理"><a href="#反向代理">#</a> 反向代理 </h2><p>想法很简单，WoD是一个服务器假设在德国的网页游戏，平时的访问时常遇到速度慢、加载卡顿的问题，分享代理工具又合适，因此，我想到可以直接利用VPS反向代理，来加快访问。</p><blockquote><p>A proxy server is a go‑between or intermediary server that forwards requests for content from multiple clients to different servers across the Internet. A <strong>reverse proxy server</strong> is a type of proxy server that typically sits behind the firewall in a private network and directs client requests to the appropriate backend server. A reverse proxy provides an additional level of abstraction and control to ensure the smooth flow of network traffic between clients and servers.</p></blockquote><p>代理服务器就是一个中间、中介服务器，它会将众多客户端的内容请求转发到网络上不同的服务器中。<strong>反向代理服务器</strong>就是代理服务器的一种，通常它处于一个私人网络的防火墙中，将客户端请求引导到合适的后端服务器中。反向代理提供更好的抽象度与管理，来保证服务器与用户间平滑的网络连接。</p><div class="post-img"><a href="/assets/img/in-post/post-reverse-proxy/reverse-proxy.jpg" data-fancybox="gallery" data-caption="Reverse Proxy" data-path="post-reverse-proxy/reverse-proxy.jpg" data-webpack="true"></a><em>Reverse Proxy</em></div><p>从图中可以清楚地看到，反向代理就是通过中间服务器代理后端服务器，用户访问时直接访问中间服务器，由中间服务器从后端服务器获得回应后将回应返回给用户。</p><div class="post-img"><a href="/assets/img/in-post/post-reverse-proxy/forward-proxy.jpg" data-fancybox="gallery" data-caption="Forward Proxy" data-path="post-reverse-proxy/forward-proxy.jpg" data-webpack="true"></a><em>Forward Proxy</em></div><p>上图中的则是正向代理，我们平时使用的VPN就属于正向代理，通过中间服务器代理客户端，由中间服务器代客户端发送内容请求，获得回应后再返回给用户。简单来说，反向代理和正向代理最直接的区别就是中间服务器究竟代理了谁。</p><h2 id="caddy-2反代wod"><a href="#caddy-2反代wod">#</a> Caddy 2反代WoD </h2><p>了解了原理，我们是骡子是马，拉出来溜溜。</p><h3 id="登陆"><a href="#登陆">#</a> 登陆 </h3><p>首先要处理的是登陆问题，WoD的登陆系统全部由JavaScript构成，获取到玩家填写的表单之后利用<code class="language-plaintext highlighter-rouge">.submit()</code>提交，但问题在于，Christian（WoD作者）hard-coded（写死了）提交对象为<code class="language-plaintext highlighter-rouge">world-of-dungeons.org</code>。</p><p>解决方法也很简单（虽然我想了很久），将登陆页面保存到本地，并用另一个域名<code class="language-plaintext highlighter-rouge">login.wannaexpresso.com</code>提供服务。将JavaScript中的提交对象改为<code class="language-plaintext highlighter-rouge">canto.wannaexpresso.com</code>就能正常登陆了。缺点是每次登陆都要登陆登陆站，而不能直接在<code class="language-plaintext highlighter-rouge">canto.wannaexpresso.com</code>登陆。</p><blockquote><p>一点思考：如果使用Nginx，或许可以使用sub_filter功能来替换表单提交对象，就可以直接在游戏站点登陆了。但Caddy尚且没有相关的功能。</p></blockquote><p>然而，提交了正确的表单，却发现提交之后被直接重定向到了<code class="language-plaintext highlighter-rouge">world-of-dungeons.org</code>，这是请求头没有设置Host的缘故。在Caddyfile中添加<code class="language-plaintext highlighter-rouge">header-up Host canto.wannaexpresso.com</code>之后，一切正常。</p><h3 id="使用"><a href="#使用">#</a> 使用 </h3><p>登陆之后，发现问题，任何操作都会导致弹出“请允许Cookie”的警示页面。</p><p>翻阅大量资料之后了解到，服务器返回的Cookie会被浏览器保存为后端服务器域名名下的cookie，导致再次访问时不能正常调取，需要将回应头中的Set-Cookie的domain值调整为代理服务器的域名。</p><p>依照Caddy的语法编写<code class="language-plaintext highlighter-rouge">header_down Set-Cookie world-of-dungeons.org wannaexpresso.com</code>之后遇到了问题，服务器返回的回应头变成了乱码。到Caddy社区一问，热心的开发者Matt一看便知问题处在Caddy 2身上，于是花了<a href="https://caddy.community/t/set-cookie-manipulation-in-reverse-proxy/7666/5" target="_blank" rel="nofollow noopener noreferrer">1分钟修复+Commit</a>，直接让我下载即时编译版测试。</p><p>我甚至不知道什么是CI，蠢蠢地档下git源码自行编译了刚刚出炉的新caddy文件，替换了服务器上的<code class="language-plaintext highlighter-rouge">/usr/bin/caddy</code>，重新开启服务器。</p><p>一次成功，现在所有WoD的功能都可以通过我的反向代理服务器访问了！</p><h3 id="caddyfile"><a href="#caddyfile">#</a> Caddyfile </h3><p>说了这么多，来看看最终的Caddyfile吧。</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 额外搭建一个登陆站来曲线修改站内网页</span>
login.wannaexpresso.com <span class="o">{</span>
  encode <span class="nb">gzip</span>
  <span class="c"># 将root设置到登陆页面所在的文件夹</span>
  root <span class="k">*</span> /home/wod
  file_server
  <span class="c"># 请求头transparent设置</span>
  header X-Real-IP <span class="o">{</span>http.request.remote.host<span class="o">}</span>
  header X-Forwarded-For <span class="o">{</span>http.request.remote.host<span class="o">}</span>
  header X-Forwarded-Port <span class="o">{</span>http.request.port<span class="o">}</span>
  header X-Forwarded-Proto <span class="o">{</span>http.request.scheme<span class="o">}</span>
<span class="o">}</span>

<span class="c"># 反向代理WoD的两个游戏服务器</span>
canto.wannaexpresso.com <span class="o">{</span>
  encode <span class="nb">gzip
  </span>reverse_proxy <span class="k">*</span> http://canto.world-of-dungeons.org <span class="o">{</span>
    <span class="c"># 请求头Host设置</span>
    header_up Host canto.world-of-dungeons.org
    <span class="c"># 请求头transparent设置</span>
    header_up X-Real-IP <span class="o">{</span>http.request.remote.host<span class="o">}</span>
    header_up X-Forwarded-For <span class="o">{</span>http.request.remote.host<span class="o">}</span>
    header_up X-Forwarded-Port <span class="o">{</span>http.request.port<span class="o">}</span>
    header_up X-Forwarded-Proto <span class="o">{</span>http.request.scheme<span class="o">}</span>
    header_down Set-Cookie world-of-dungeons.org wannaexpresso.com
  <span class="o">}</span>
<span class="o">}</span>

zhao.wannaexpresso.com <span class="o">{</span>
  encode <span class="nb">gzip
  </span>reverse_proxy <span class="k">*</span> http://zhao.world-of-dungeons.org <span class="o">{</span>
    header_up Host zhao.world-of-dungeons.org
    header_up X-Real-IP <span class="o">{</span>http.request.remote.host<span class="o">}</span>
    header_up X-Forwarded-For <span class="o">{</span>http.request.remote.host<span class="o">}</span>
    header_up X-Forwarded-Port <span class="o">{</span>http.request.port<span class="o">}</span>
    header_up X-Forwarded-Proto <span class="o">{</span>http.request.scheme<span class="o">}</span>
    header_down Set-Cookie world-of-dungeons.org wannaexpresso.com
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>是不是非常简单呢 ;)</p></div><ul class="post-pager"><li class="pager--next"><a class="button" href="/2020/04/28/jekyll-filter-plugin/" data-toggle="tooltip" data-placement="top" title="编写Jekyll摘要插件"> NEXT<br><span>编写Jekyll摘要插件</span></a></li><li class="pager--prev"><a class="button" href="/2020/04/21/aria-pi/" data-toggle="tooltip" data-placement="top" title="用RaspberryPi搭建Aria2+Caddy2下载站"> PREV<br><span>用RaspberryPi搭建Aria2+Caddy2下载站</span></a></li></ul><div id="vcomments"></div></div></section><footer class="about condensed"><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></footer></main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-159368053-1"></script><script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159368053-1');
    </script></body></html>