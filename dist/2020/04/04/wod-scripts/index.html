<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="google-site-verification" content="zrVlHARQzSGPX8n0jKJdP_fCO0AvtLXxoPmYkJh-oXw"/><meta name="description" content="Act local, think global with DotIN13!"><meta name="keywords" content="WoD, Tampermonkey, and Javascript"><meta name="theme-color" content="#ff94c2"><meta lang="zh"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png?v=2bA3g2vyYK"><link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg?v=2bA3g2vyYK" color="#dc2267"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico?v=2bA3g2vyYK"><meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml?v=2bA3g2vyYK"><meta property="og:title" content="给WoD写Tampermonkey脚本的那些事儿 - DOTIN13'S BLOG"><meta property="og:type" content="article"><meta property="og:description" content="再写脚本我就剁手 目前我已经断断续续地给WoD写了5个Tampermonkey脚本，可惜真正受到玩家欢迎的只有两款。又因为WoD的玩家数量实在是太少，太少。往多了算，或许全国的14亿人里能有300人在玩WoD？ 我说，ZZZ，你要是再写WoD脚本，要不你就剁手吧。行，不过剁手有点疼，要不还是剁希莉娅吧…… Function Scope 调用函数的Scope可以说是我在编写脚本中遇..."><meta property="article:published_time" content="2020-04-04T00:00:00Z"><meta property="article:author" content="DotIN13"><meta property="article:tag" content="WoD"><meta property="article:tag" content="Tampermonkey"><meta property="article:tag" content="Javascript"><meta property="og:image" content="https://www.wannaexpresso.com/assets/img/orange.webp"><meta property="og:url" content="https://www.wannaexpresso.com/2020/04/04/wod-scripts/"><meta property="og:site_name" content="DOTIN13'S BLOG"><link rel="canonical" href="https://www.wannaexpresso.com/2020/04/04/wod-scripts/"><script src="/assets/public/application-bundle.js"></script><link rel="stylesheet" href="/assets/public/application.css"><script src="/assets/public/posts-bundle.js"></script><title>给WoD写Tampermonkey脚本的那些事儿 - DOTIN13'S BLOG</title></head><body><main class="container"><section class="about"><div class="about-header"><div class="about-title"><a href="/" id="avatar" data-caption="DotIN13" data-webpack="true" data-path="/assets/img/orange.webp"></a><h2 id="title"><a href="/">DotIN13</a></h2></div><p class="tagline">LACKAWANNA<br>EXPRESSO</p></div><div class="buttons"><a href="/en-us/" class="language-selection button icon-translate" aria-label="Change locale to English."></a><a href="/feed.xml" class="feed button icon-rss_feed" aria-label="RSS Feed"></a><input type="checkbox" class="dark-mode-toggle" aria-label="dark-mode-switch"><a href="#" aria-label="Click to toggle darkmode." class="button"><span class="icon-moon"></span><span class="icon-sun"></span></a><a href="#" id="pwa-install" class="install button icon-install disabled" aria-label="Install as Web Application"><span>Install</span></a></div><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></section><section class="content"><div class="post-container"><a class="post-link" href="/2020/04/04/wod-scripts/"><h2 class="post-title">给WoD写Tampermonkey脚本的那些事儿</h2><h3 class="post-subtitle">WoD Scripting Experience</h3></a><div class="post-meta"><div class="post-categories"><a class="button" href="/archive/?tag=WoD" title="WoD">WoD</a><a class="button" href="/archive/?tag=Tampermonkey" title="Tampermonkey">Tampermonkey</a><a class="button" href="/archive/?tag=Javascript" title="Javascript">Javascript</a></div><div class="post-misc"><div class="post-date"><i class="icon-calendar"></i>Apr 4, 2020</div></div></div><div class="post"><h2 id="再写脚本我就剁手"><a href="#再写脚本我就剁手">#</a> 再写脚本我就剁手 </h2><p>目前我已经断断续续地给WoD写了5个Tampermonkey脚本，可惜真正受到玩家欢迎的只有两款。又因为WoD的玩家数量实在是太少，太少。往多了算，或许全国的14亿人里能有300人在玩WoD？</p><iframe width="100%" height="325" frameborder="0" scrolling="no" marginwidth="0" marginheight="0" src="https://www.google.com/publicdata/embed?ds=d5bncppjof8f9_&amp;ctype=l&amp;strail=false&amp;bcs=d&amp;nselm=h&amp;met_y=sp_pop_totl&amp;scale_y=lin&amp;ind_y=false&amp;rdim=world&amp;idim=country:CHN:IND:USA&amp;ifdim=world&amp;hl=en_US&amp;dl=en&amp;ind=false"></iframe><p>我说，ZZZ，你要是再写WoD脚本，要不你就剁手吧。行，不过剁手有点疼，要不还是剁希莉娅吧……</p><h2 id="function-scope"><a href="#function-scope">#</a> Function Scope </h2><p>调用函数的Scope可以说是我在编写脚本中遇到的第一个问题。当你在Tampermonkey中信心满满地写好函数，希望把它添加到一个button的onclick事件中，却在调试中始终无法触发，你的内心是不是充满了纠结？</p><p>其实问题非常简单，Tampermonkey的脚本默认模板本身就是一个anonymous function。</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//your script</span>
<span class="p">})();</span>
</code></pre></div></div><p>以上的这段代码等同于：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">a</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//your script</span>
<span class="p">}</span>
<span class="nx">a</span><span class="p">();</span>
</code></pre></div></div><p>那么既然你的整个脚本都身处这个function的scope中，你叫浏览器怎么定位到这个function中的另一个function呢？所以一种解决方案是直接抛弃这个Tampermonkey默认提供的function外壳，在global scope中完成你的脚本，但这样难免会遇到你的variable与网站其他variable冲突的可能。所以你可以通过window对象来定义你的global function，像这样…</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//your function</span>
    <span class="p">}</span>
<span class="p">})();</span>
</code></pre></div></div><p>这样，你就可以在global环境中通过<code class="language-plaintext highlighter-rouge">a()</code>来直接在事件中调用这个函数了。</p><h2 id="regexp"><a href="#regexp">#</a> RegExp </h2><p>我是一个货真价实的Coding Rookie，所以当我在编写我的第一个脚本WoD Jumpbox Enhanced的时候，看到网站js中所用的一串不明所以的代码，瞬间蒙了圈儿：<code class="language-plaintext highlighter-rouge">/^\s*\[\s*([^:]+?)\s*:\s*(.+?)\s*\]\s*$/</code>。</p><p>热心群友Hyt和Eric鸽鸽亲切地帮我解答了疑惑：原来这就是大名鼎鼎的正则表达式。不查不知道，一查吓一跳，原来正则表达式的规矩这么多。在翻阅了<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp" target="_blank" rel="nofollow noopener noreferrer">MDN</a>的资料之后，才算对这种匹配字符串的神器有了些许了解。</p><p>不过对于什么时候利用<code class="language-plaintext highlighter-rouge">g</code>进行全局匹配，什么时候需要利用<code class="language-plaintext highlighter-rouge">m</code>来多行匹配，我还是处于<strong>随心所欲</strong>的状态……</p><h2 id="xmlhttprequest"><a href="#xmlhttprequest">#</a> XMLHttpRequest </h2><p>在宝库好感度这个脚本中，涉及到要读取WoD提供的宝库物品列表，翻看了一圈，要么用JQuery的<code class="language-plaintext highlighter-rouge">$().load</code>，要么利用javascript内建的XMLHttpRequest。</p><p>读取宝库列表是一次性的操作，我非常简单地建立了一个<code class="language-plaintext highlighter-rouge">display: none</code>的div来存放<code class="language-plaintext highlighter-rouge">$().load</code>拉取的信息，蒙混过关。</p><p>但当我在制作装备最低要求拉取这个脚本时，却发现<code class="language-plaintext highlighter-rouge">$().load</code>在for循环中完全无法工作，猜想是上一个load还没有完成，for已经进入了下一次循环，导致了所有load动作都被跳过。无奈的我只好硬着头皮研究XMLHttpRequest，好在StackOverflow和MDN网站上的资料还是非常丰富的，不久我便明白了XMLHttpRequest来获取网页内容是一种定死的异步操作，即可以同时有多个拉取的操作在进行。这给数据的记录带来了问题，因为遍历所有装备时，我按照装备的位置记录了它们的i值，以有序地将各个装备信息存入数组，但这个i值应该怎么传递给XMLHttpRequest的Callback函数呢？</p><p>万能的<a href="https://stackoverflow.com/questions/25220486/xmlhttprequest-in-for-loop" target="_blank" rel="nofollow noopener noreferrer">StackOverflow</a>给出了解答：</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>

    <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span> <span class="c1">//for loop</span>
            <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">){</span>
                <span class="nx">xhr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
                <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">closure.php?data=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
                <span class="nx">xhr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="nx">xhr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">){</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Response from request </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="dl">'</span><span class="s1"> [ </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">xhr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">responseText</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">]</span><span class="dl">'</span><span class="p">);</span> 
                    <span class="p">}</span>
                <span class="p">};</span>
                <span class="nx">xhr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">send</span><span class="p">();</span>
            <span class="p">})(</span><span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">})();</span>

<span class="p">};</span>
</code></pre></div></div><p>网络大神利用anonymous function，轻松地将i传递给了callback函数，我的插件编写也得到了拯救。</p><h2 id="后记"><a href="#后记">#</a> 后记 </h2><p>剁手？只是说着玩玩的。确实开发脚本遇到了很多问题，我的用户群体也非常的少，但我在这个过程中也收获很多。为自己喜欢的东西而付出，这种幸福又还能持续多久呢？</p><p>最后的最后，必须要感谢首席脚本测试员lnsh02……</p></div><ul class="post-pager"><li class="pager--next"><a class="button" href="/2020/04/05/batch-refit/" data-toggle="tooltip" data-placement="top" title="用Batch Replacer轻松切换到Rouge高亮引擎"> NEXT<br><span>用Batch Replacer轻松切换到Rouge高亮引擎</span></a></li><li class="pager--prev"><a class="button" href="/wod/2020/04/03/wod-physics/" data-toggle="tooltip" data-placement="top" title="WoD宇宙普遍定律"> PREV<br><span>WoD宇宙普遍定律</span></a></li></ul><div id="vcomments"></div></div></section><footer class="about condensed"><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></footer></main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-159368053-1"></script><script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159368053-1');
    </script></body></html>