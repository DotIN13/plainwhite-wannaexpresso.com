<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="google-site-verification" content="zrVlHARQzSGPX8n0jKJdP_fCO0AvtLXxoPmYkJh-oXw"/><meta name="description" content="Act local, think global with DotIN13!"><meta name="keywords" content="Linux, Ruby, Ruby on Rails, and WoD"><meta name="theme-color" content="#ff94c2"><meta lang="zh"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png?v=2bA3g2vyYK"><link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg?v=2bA3g2vyYK" color="#dc2267"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico?v=2bA3g2vyYK"><meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml?v=2bA3g2vyYK"><meta property="og:title" content="RoR开发日志一 - DOTIN13'S BLOG"><meta property="og:type" content="article"><meta property="og:description" content="Rails开发日志 在利用Head First Ruby学习完Ruby之后，又在网上找到了Hartl的The Ruby on Rails Tutorial自学。不能说成才，总算也是对Rails的使用有了一些基本的认识，由于最爱的WoD（World of Dungeons）年久失修，便决定用Rails来做一个Rebuild。Hartl的书相对来说比较基础，很多实际问题都没有涉及到，这也对我的..."><meta property="article:published_time" content="2020-05-30T00:00:00Z"><meta property="article:author" content="DotIN13"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Ruby"><meta property="article:tag" content="Ruby on Rails"><meta property="article:tag" content="WoD"><meta property="og:image" content="https://www.wannaexpresso.com/assets/img/orange.webp"><meta property="og:url" content="https://www.wannaexpresso.com/2020/05/30/rails-development-1/"><meta property="og:site_name" content="DOTIN13'S BLOG"><link rel="canonical" href="https://www.wannaexpresso.com/2020/05/30/rails-development-1/"><script src="/assets/public/application-bundle.js"></script><link rel="stylesheet" href="/assets/public/application.css"><script src="/assets/public/posts-bundle.js"></script><title>RoR开发日志一 - DOTIN13'S BLOG</title></head><body><main class="container"><section class="about"><div class="about-header"><div class="about-title"><a href="/" id="avatar" data-caption="DotIN13" data-webpack="true" data-path="/assets/img/orange.webp"></a><h2 id="title"><a href="/">DotIN13</a></h2></div><p class="tagline">LACKAWANNA<br>EXPRESSO</p></div><div class="buttons"><a href="/en-us/" class="language-selection button icon-translate" aria-label="Change locale to English."></a><a href="/feed.xml" class="feed button icon-rss_feed" aria-label="RSS Feed"></a><input type="checkbox" class="dark-mode-toggle" aria-label="dark-mode-switch"><a href="#" aria-label="Click to toggle darkmode." class="button"><span class="icon-moon"></span><span class="icon-sun"></span></a><a href="#" id="pwa-install" class="install button icon-install disabled" aria-label="Install as Web Application"><span>Install</span></a></div><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></section><section class="content"><div class="post-container"><a class="post-link" href="/2020/05/30/rails-development-1/"><h2 class="post-title">RoR开发日志一</h2><h3 class="post-subtitle">Ruby on Rails Development Log One</h3></a><div class="post-meta"><div class="post-categories"><a class="button" href="/archive/?tag=Linux" title="Linux">Linux</a><a class="button" href="/archive/?tag=Ruby" title="Ruby">Ruby</a><a class="button" href="/archive/?tag=Ruby+on+Rails" title="Ruby on Rails">Ruby on Rails</a><a class="button" href="/archive/?tag=WoD" title="WoD">WoD</a></div><div class="post-misc"><div class="post-date"><i class="icon-calendar"></i>May 30, 2020</div></div></div><div class="post"><h2 id="rails开发日志"><a href="#rails开发日志">#</a> Rails开发日志 </h2><p>在利用Head First Ruby学习完Ruby之后，又在网上找到了Hartl的The Ruby on Rails Tutorial自学。不能说成才，总算也是对Rails的使用有了一些基本的认识，由于最爱的WoD（World of Dungeons）年久失修，便决定用Rails来做一个Rebuild。Hartl的书相对来说比较基础，很多实际问题都没有涉及到，这也对我的开发产生了很多困扰，但好在Stackoverflow实在太强，踏破铁鞋无觅处，得来全不费功夫的例子实在是太多。</p><h2 id="企业邮箱"><a href="#企业邮箱">#</a> 企业邮箱 </h2><p>用自己的邮箱来做Devise验证邮箱实在是非常愚蠢（误），于是便决定准备一个企业邮箱。一开始用的是网易免费企业邮箱，却发现连最基本的安全码登陆都做不到，于是便注销了帐号转战腾讯。腾讯企业邮箱相对管理面板更为现代，而且使用微信登陆比较方便，但如果一个人要有多个企业邮箱可能就比较麻烦了。</p><p>首先我配置了<code class="language-plaintext highlighter-rouge">app/mailers/application_mailer.rb</code>的发信地址。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="o">&lt;</span><span class="n">email</span> <span class="n">address</span><span class="o">&gt;</span>
  <span class="n">layout</span> <span class="s1">'mailer'</span>
<span class="k">end</span>
</code></pre></div></div><p>然后我决定按照devise的documentation配置一个新的mailer<code class="language-plaintext highlighter-rouge">app/mailers/ezantoh_mailer.rb</code>。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># frozen_string_literal: true</span>

<span class="k">class</span> <span class="nc">EzantohMailer</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">Mailer</span>
  <span class="n">helper</span> <span class="ss">:application</span> <span class="c1"># gives access to all helpers defined within `application_helper`.</span>
  <span class="kp">include</span> <span class="no">Devise</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">UrlHelpers</span> <span class="c1"># Optional. eg. `confirmation_url`</span>
  <span class="n">default</span> <span class="ss">template_path: </span><span class="s1">'devise/mailer'</span> <span class="c1"># to make sure that your mailer uses the devise views</span>
  <span class="c1"># If there is an object in your application that returns a contact email, you can use it as follows</span>
  <span class="c1"># Note that Devise passes a Devise::Mailer object to your proc, hence the parameter throwaway (*).</span>
  <span class="c1"># default from: -&gt;(*) { Class.instance.email_address }</span>
<span class="k">end</span>
</code></pre></div></div><p>然后需要在Devise的Initializer里调用我的Mailer。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># ==&gt; Mailer Configuration</span>
  <span class="c1"># Configure the e-mail address which will be shown in Devise::Mailer,</span>
  <span class="c1"># note that it will be overwritten if you use your own mailer class</span>
  <span class="c1"># with default "from" parameter.</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">mailer_sender</span> <span class="o">=</span> <span class="s1">'admin@wannaexpresso.com'</span>

  <span class="c1"># Configure the class responsible to send e-mails.</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">mailer</span> <span class="o">=</span> <span class="s1">'EzantohMailer'</span>

  <span class="c1"># Configure the parent class responsible to send e-mails.</span>
  <span class="c1"># config.parent_mailer = 'ActionMailer::Base'</span>
</code></pre></div></div><p>最后在<code class="language-plaintext highlighter-rouge">config/environments/production.rb</code>中配置了详细的邮箱讯息。这时需要从企业邮箱设置页面获取安全码。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># SMTP settings</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
  <span class="n">host</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">host</span><span class="o">&gt;</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host: </span><span class="n">host</span> <span class="p">}</span>
  <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">address: </span><span class="s1">'smtp.exmail.qq.com'</span><span class="p">,</span>
    <span class="ss">port: </span><span class="s1">'587'</span><span class="p">,</span>
    <span class="ss">authentication: :login</span><span class="p">,</span>
    <span class="ss">user_name: </span><span class="o">&lt;</span><span class="n">email</span> <span class="n">address</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="ss">password: </span><span class="o">&lt;</span><span class="n">email</span> <span class="n">secret</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="ss">domain: </span><span class="s1">'exmail.qq.com'</span><span class="p">,</span>
    <span class="ss">enable_starttls_auto: </span><span class="kp">true</span>
  <span class="p">}</span>
</code></pre></div></div><p>一开始我的设置怎么都不能发送邮件，最后发现是domain的设置问题，需要设置为<code class="language-plaintext highlighter-rouge">exmail.qq.com</code>。此外，这里的端口设置我尝试过许多，25、465、587似乎都可以使用，但是使用465端口要额外添加<code class="language-plaintext highlighter-rouge">tls: true</code>。</p><h2 id="could-not-find-generator"><a href="#could-not-find-generator">#</a> Could not find generator </h2><p>我希望能够给app添加密码强度validation，在网上搜索之后找到了Devise的插件Devise Security。在修改<code class="language-plaintext highlighter-rouge">Gemfile</code>并且<code class="language-plaintext highlighter-rouge">bundle install</code>之后，按照documentation使用<code class="language-plaintext highlighter-rouge">rails generate</code>安装插件，却遇到了<code class="language-plaintext highlighter-rouge">could not find generator</code>的错误。</p><p>在Stackoverflow遨游之后，找到了解决办法。原因是Spring服务器没有记录新安装的gem，需要重启Spring。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/spring stop
</code></pre></div></div><p>Spring会在下次使用<code class="language-plaintext highlighter-rouge">rails</code>命令时自动重启。这时再使用<code class="language-plaintext highlighter-rouge">generate</code>命令就可以正常安装Devise Security了。</p><h2 id="提交表单错误信息不显示"><a href="#提交表单错误信息不显示">#</a> 提交表单错误信息不显示 </h2><p>我首先在游戏里创建的是英雄职业，职业拥有一些加成（Modification），由于加成还可以被种族、装备所拥有，因此这里我用了Polymorphic Association，而修改种族的表单也因此需要做成Nested Dynamic Form。</p><p>一开始我用了Cocoon gem，却发现表单提交错误信息一直不能显示，以为是Cocoon的bug，于是又按照<a href="https://www.youtube.com/watch?v=qM4ZK0uuZUE" target="_blank" rel="nofollow noopener noreferrer">Gorails教程</a>和<a href="https://stimulusjs.org/" target="_blank" rel="nofollow noopener noreferrer">Stimulus JS</a> Documentation用Stimulus重构，问题却仍然存在。</p><p>在Stackoverflow上找到的相关问题都是由于表单提交不成功时使用了redirect导致的表单model被重置。而我已经使用了<code class="language-plaintext highlighter-rouge">render 'new'</code>，所以没能找到答案。</p><p>随后，我仔细观察Server Log发现，其他一些页面的log是<code class="language-plaintext highlighter-rouge">render xxx as HTML</code>，而我的表单页面提交之后，却是<code class="language-plaintext highlighter-rouge">render xxx as JS</code>。我猜测，是由于页面通过Ajax刷新，而flash是在下一次HTML redirect/render时显示，这导致了错误信息不能正确显示。</p><p>在<a href="https://edgeguides.rubyonrails.org/form_helpers.html#making-select-boxes-with-ease" target="_blank" rel="nofollow noopener noreferrer">Rails Guide</a>中找到了解决的办法，也就是说，在表单中默认是<code class="language-plaintext highlighter-rouge">remote: true</code>，也就是数据提交会由XHR（Ajax）接管。如果需要关闭，需要在<code class="language-plaintext highlighter-rouge">form_with</code>中设置<code class="language-plaintext highlighter-rouge">local: true</code>。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">form_with</span><span class="p">(</span><span class="ss">url: </span><span class="n">search_path</span><span class="p">,</span> <span class="ss">method: </span><span class="s2">"patch"</span><span class="p">,</span> <span class="ss">local: </span><span class="kp">true</span><span class="p">)</span>
</code></pre></div></div><p>如果执意要用Ajax，Guides指出可以参考<a href="https://edgeguides.rubyonrails.org/working_with_javascript_in_rails.html#remote-elements" target="_blank" rel="nofollow noopener noreferrer">Working with JavaScript in Rails</a>。</p><h2 id="总结"><a href="#总结">#</a> 总结 </h2><p>开发一个Web App确实很有难度，需要耐心，需要创造力。更重要的是需要无时不刻地抱有一颗谦虚的心，不断地学习、探究，因为只有站在巨人的肩膀上，才能看的更远。</p></div><ul class="post-pager"><li class="pager--next"><a class="button" href="/2020/06/04/rails-development-2/" data-toggle="tooltip" data-placement="top" title="RoR开发日志二"> NEXT<br><span>RoR开发日志二</span></a></li><li class="pager--prev"><a class="button" href="/2020/05/14/apple-pie/" data-toggle="tooltip" data-placement="top" title="简单制作手抓饼苹果派"> PREV<br><span>简单制作手抓饼苹果派</span></a></li></ul><div id="vcomments"></div></div></section><footer class="about condensed"><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></footer></main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-159368053-1"></script><script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159368053-1');
    </script></body></html>