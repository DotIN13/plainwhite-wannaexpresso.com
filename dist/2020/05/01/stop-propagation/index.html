<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="google-site-verification" content="zrVlHARQzSGPX8n0jKJdP_fCO0AvtLXxoPmYkJh-oXw"/><meta name="description" content="Act local, think global with DotIN13!"><meta name="keywords" content="JavaScript and Blog"><meta name="theme-color" content="#ff94c2"><meta lang="zh"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png?v=2bA3g2vyYK"><link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg?v=2bA3g2vyYK" color="#dc2267"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico?v=2bA3g2vyYK"><meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml?v=2bA3g2vyYK"><meta property="og:title" content="切换页面后onclick不工作 stopPropagation来救场 - DOTIN13'S BLOG"><meta property="og:type" content="article"><meta property="og:description" content="Plainwhite主题 在网上兜兜转转，发现用Hux主题的朋友实在是非常多，可见这一主题观感、实用度上还是很能笼络人心的。不过既然大家都在用，难免显得有些缺乏个性，于是便又上网搜刮，更换到了@thelehhman制作的Plainwhite。主题本身很棒，不过非常简单，很多功能都需要手动添加，比如——搜索功能。 Plainwhite Searchbar 搜索功能，之前已经在Hux..."><meta property="article:published_time" content="2020-05-01T00:00:00Z"><meta property="article:author" content="DotIN13"><meta property="article:tag" content="JavaScript"><meta property="article:tag" content="Blog"><meta property="og:image" content="https://www.wannaexpresso.com/assets/img/orange.webp"><meta property="og:url" content="https://www.wannaexpresso.com/2020/05/01/stop-propagation/"><meta property="og:site_name" content="DOTIN13'S BLOG"><link rel="canonical" href="https://www.wannaexpresso.com/2020/05/01/stop-propagation/"><script src="/assets/public/application-bundle.js"></script><link rel="stylesheet" href="/assets/public/application.css"><script src="/assets/public/posts-bundle.js"></script><title>切换页面后onclick不工作 stopPropagation来救场 - DOTIN13'S BLOG</title></head><body><main class="container"><section class="about"><div class="about-header"><div class="about-title"><a href="/" id="avatar" data-caption="DotIN13" data-webpack="true" data-path="/assets/img/orange.webp"></a><h2 id="title"><a href="/">DotIN13</a></h2></div><p class="tagline">LACKAWANNA<br>EXPRESSO</p></div><div class="buttons"><a href="/en-us/" class="language-selection button icon-translate" aria-label="Change locale to English."></a><a href="/feed.xml" class="feed button icon-rss_feed" aria-label="RSS Feed"></a><input type="checkbox" class="dark-mode-toggle" aria-label="dark-mode-switch"><a href="#" aria-label="Click to toggle darkmode." class="button"><span class="icon-moon"></span><span class="icon-sun"></span></a><a href="#" id="pwa-install" class="install button icon-install disabled" aria-label="Install as Web Application"><span>Install</span></a></div><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></section><section class="content"><div class="post-container"><div class="multilingual-title"><a class="translate button" href="/en-us/2020/05/01/stop-propagation/"><i class="icon-translate"></i></a><a class="post-link" href="/2020/05/01/stop-propagation/"><h2 class="post-title">切换页面后onclick不工作 stopPropagation来救场</h2></a></div><a class="post-link" href="/2020/05/01/stop-propagation/"><h3 class="post-subtitle">Onclick Not Working after Switching Pages? stopPropagation Saves the Day!</h3></a><div class="post-meta"><div class="post-categories"><a class="button" href="/archive/?tag=JavaScript" title="JavaScript">JavaScript</a><a class="button" href="/archive/?tag=Blog" title="Blog">Blog</a></div><div class="post-misc"><div class="post-date"><i class="icon-calendar"></i>May 1, 2020</div></div></div><div class="post"><h2 id="plainwhite主题"><a href="#plainwhite主题">#</a> Plainwhite主题 </h2><p>在网上兜兜转转，发现用Hux主题的朋友实在是非常多，可见这一主题观感、实用度上还是很能笼络人心的。不过既然大家都在用，难免显得有些缺乏个性，于是便又上网搜刮，更换到了<a href="https://github.com/thelehhman/plainwhite-jekyll" target="_blank" rel="nofollow noopener noreferrer">@thelehhman制作的Plainwhite</a>。主题本身很棒，不过非常简单，很多功能都需要手动添加，比如——搜索功能。</p><div class="post-img"><a href="/assets/img/in-post/post-searchbar/searchbar.png" data-fancybox="gallery" data-caption="Plainwhite Searchbar" data-path="post-searchbar/searchbar.png" data-webpack="true"></a><em>Plainwhite Searchbar</em></div><p>搜索功能，之前已经在Hux主题上折腾过了，为Hux Blog添加了一个<a href="/2020/03/14/jekyll-blog-searchbar/">简单的Bootstrap风格搜索框</a>。不过，Plainwhite主题本身非常简洁，简洁到我不知道该往哪里加搜索框才能保证页面的纯净，思来想去，最后决定放在Page页面的顶部。</p><h2 id="dropdown在safari不能工作"><a href="#dropdown在safari不能工作">#</a> Dropdown在Safari不能工作 </h2><p>我的目标是能够在鼠标点击搜索区域时显示搜索框与搜索结果区域，因此很自然地想到用CSS的pseudoclass selector来实现hover与focus-within的时候显示内容。</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code># HTML
<span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"posts-labelgroup"</span> <span class="na">id=</span><span class="s">"posts-labelgroup"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1</span> <span class="na">id=</span><span class="s">"posts-label"</span> <span class="na">style=</span><span class="s">"width: 50px;"</span><span class="nt">&gt;</span>posts<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"search-container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"search-section"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"icon-search"</span><span class="nt">&gt;&lt;/i&gt;&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"search"</span> <span class="na">id=</span><span class="s">"searchbar"</span>
        <span class="na">autocomplete=</span><span class="s">"off"</span> <span class="na">aria-label=</span><span class="s">"search in posts"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"search-results"</span> <span class="na">id=</span><span class="s">"search-results"</span> <span class="na">data-placeholder=</span><span class="s">"NO RESULTS"</span> <span class="na">style=</span><span class="s">"display: none;"</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</code></pre></div></div><div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">#</span> <span class="nt">SCSS</span>
<span class="nc">.posts-labelgroup</span> <span class="p">{</span>
  <span class="c1">// searchbar style</span>
  <span class="k">&amp;</span><span class="nd">:focus-within</span> <span class="p">{</span>
    <span class="c1">// searchbar style on focus</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>在PC和Android浏览器上的显示效果非常好，操作也正常。但到了IOS Safari却出了问题，点击下拉菜单中的结果条目并不能正常跳转。似乎是点按搜索框外的目标使得<code class="language-plaintext highlighter-rouge">focus</code>丢失，<code class="language-plaintext highlighter-rouge">:focus-within</code>选择器失效，下拉菜单消失，然后才触发点击结束事件，导致了不能打开链接。Safari差评！</p><p>了解到一些开发者的意见是<code class="language-plaintext highlighter-rouge">:hover</code>在触屏设备上往往不能正常运作，建议使用JavaScript调节<code class="language-plaintext highlighter-rouge">class</code>来解决这一问题。既然如此，VSCode，启动！</p><h2 id="onclick偶尔失效"><a href="#onclick偶尔失效">#</a> Onclick偶尔失效 </h2><p>我先使用JavaScript编写了onclick事件，在点击后为最外层的<code class="language-plaintext highlighter-rouge">$labelGroup</code>添加<code class="language-plaintext highlighter-rouge">focus-within</code>类，以配合CSS达到动画效果。</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span> <span class="nx">JavaScript</span> <span class="nx">Excerpt</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// add click eventlistener</span>
  <span class="nx">$labelGroup</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// animation to expand search results</span>
  <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

  <span class="nx">$labelGroup</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">mouseleave</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="nx">searchCollapse</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">searchCollapse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// animation to collapse search results</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div><p>但是，在测试过程中我却发现，点击搜索框时偶尔会出现仅仅是搜索框获得focus，阴影、显示结果列表等其他动画“没有运行”的情况。此时只有双击搜索框，才能重新触发动画。这一bug通常出现在切换到其他页面再切换回博客的情况下，虽然不容易触发，但对于我这个强迫症来说非常难受。</p><h2 id="尝试解决"><a href="#尝试解决">#</a> 尝试解决 </h2><p>我在click事件的回调函数中增加了<code class="language-plaintext highlighter-rouge">console.log()</code>，却发现即便动画没有显示，回调函数的的确确得到了执行。网络上大多数相关的问题都是因为其他情况，回调函数没有得到执行，这就让我遇到的问题显得愈发神秘，甚至让我以为是浏览器的问题，然而经过测试，发现并非如此，另有其因。</p><p>找到问题的原因是在我尝试了无数可能的解决方案之后。几乎是巧合地，我照搬了网络上的一段代码，其<code class="language-plaintext highlighter-rouge">click</code>事件回调函数中包含了一句<code class="language-plaintext highlighter-rouge">e.stopPropagation()</code>，经过尝试，我发现之前困扰我的问题竟然解决了，简直是踏破铁鞋无觅处，得来全不费功夫。</p><h2 id="剥丝抽茧"><a href="#剥丝抽茧">#</a> 剥丝抽茧 </h2><p>这一问题要从头说起，就不得不提JavaScript处理事件时的<a href="https://javascript.info/bubbling-and-capturing" target="_blank" rel="nofollow noopener noreferrer">Bubbling（冒泡）</a>。</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;style&gt;</span>
  <span class="nt">body</span> <span class="o">*</span> <span class="p">{</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="no">blue</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;form</span> <span class="na">onclick=</span><span class="s">"alert('form')"</span><span class="nt">&gt;</span>FORM
  <span class="nt">&lt;div</span> <span class="na">onclick=</span><span class="s">"alert('div')"</span><span class="nt">&gt;</span>DIV
    <span class="nt">&lt;p</span> <span class="na">onclick=</span><span class="s">"alert('p')"</span><span class="nt">&gt;</span>P<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div><style>
  #code-tryout {
    border: solid 2px #f4f4f4;   
  }
  #code-tryout * {
    margin: 10px;
    border: 1px solid #268bd2;
  }
</style><div id="code-tryout"><form onclick="alert('form')">FORM <div onclick="alert('div')">DIV <p onclick="alert('p')">P</p></div></form></div><p>当你在一个元素上触发事件时，该事件会向父级元素一路传递，一直传递到<code class="language-plaintext highlighter-rouge">document.body</code>，对所有沿途的元素触发该事件。上面的这个例子非常直观，当点击<code class="language-plaintext highlighter-rouge">&lt;p&gt;</code>元素后，先触发了<code class="language-plaintext highlighter-rouge">&lt;p&gt;</code>自身的click事件，然后是<code class="language-plaintext highlighter-rouge">&lt;div&gt;</code>，最后是<code class="language-plaintext highlighter-rouge">&lt;form&gt;</code>。这就是JavaScript事件的冒泡。</p><p>那么在我们的搜索框中这一问题是如何体现的呢？原理其实很简单（虽然我想了很久才相通）。</p><p class="codepen" data-height="265" data-theme-id="light" data-default-tab="js,result" data-user="DotIN13" data-slug-hash="qBOXjWJ" style="height: 265px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;" data-pen-title="stopPropagation"><span>See the Pen <a href="https://codepen.io/DotIN13/pen/qBOXjWJ"> stopPropagation</a> by DotIN13 (<a href="https://codepen.io/DotIN13">@DotIN13</a>) on <a href="https://codepen.io">CodePen</a>.</span></p><script async="" src="https://static.codepen.io/assets/embed/ei.js"></script><p>上面是有和没有<code class="language-plaintext highlighter-rouge">stopPropagation()</code>的两个示例，在错误示例中，首先是为<code class="language-plaintext highlighter-rouge">input</code>添加了一个<code class="language-plaintext highlighter-rouge">click</code>事件，显示一串字符，然后又添加了一个<code class="language-plaintext highlighter-rouge">mouseleave</code>事件，检测到鼠标离开后，再为外围<code class="language-plaintext highlighter-rouge">div</code>添加一个<code class="language-plaintext highlighter-rouge">click</code>事件，取消字符串显示。这就会导致问题：当你的鼠标不经意经过<code class="language-plaintext highlighter-rouge">input</code>时，JavaScript不管你有没有点击输入框，都会为你创建一个外围<code class="language-plaintext highlighter-rouge">div</code>点击事件。此时你再点击输入框，输入框点击事件触发，显示字符串，但随即又冒泡触发<code class="language-plaintext highlighter-rouge">div</code>点击事件，隐藏字符串，导致了视觉上无法观察到字符串的显示。</p><p>对应到我们的博客搜索框，在切换页面后鼠标一旦经过搜索框，就会为<code class="language-plaintext highlighter-rouge">document.body</code>创建<code class="language-plaintext highlighter-rouge">click</code>事件，此时再点击搜索框，就会出现动画不出现的问题——因为<code class="language-plaintext highlighter-rouge">searchbar</code>与<code class="language-plaintext highlighter-rouge">document.body</code>的两个事件几乎同时触发，效果相互抵消了。</p><p>理解了问题的源头，解决就非常简单了，<code class="language-plaintext highlighter-rouge">e.stopPropagation();</code>是为这类问题量身定做的，只要在搜索框事件中添加，就可以防止点击搜索框时发生冒泡。</p><h2 id="后话"><a href="#后话">#</a> 后话 </h2><p>当然，这一问题也有其他可能的解决路径，将<code class="language-plaintext highlighter-rouge">mouseleave</code>事件放在搜索框的<code class="language-plaintext highlighter-rouge">click</code>中，保证点击后才创建<code class="language-plaintext highlighter-rouge">mouseleave</code>事件，当点击外围后，再将<code class="language-plaintext highlighter-rouge">mouseleave</code>事件同<code class="language-plaintext highlighter-rouge">body.click</code>事件统统移除，毁尸灭迹。</p><p>编程开发不像很多人想的那样，它永远是一道开放题，人类无穷的创造力与想象力，才是这张答卷的边界。</p></div><ul class="post-pager"><li class="pager--next"><a class="button" href="/en-us/2020/05/01/stop-propagation/" data-toggle="tooltip" data-placement="top" title="Onclick Not Working after Switching Pages? stopPropagation Saves the Day!"> NEXT<br><span>Onclick Not Working after Switching Pages? stopPropagation Saves the Day!</span></a></li><li class="pager--prev"><a class="button" href="/2020/04/28/jekyll-filter-plugin/" data-toggle="tooltip" data-placement="top" title="编写Jekyll摘要插件"> PREV<br><span>编写Jekyll摘要插件</span></a></li></ul><div id="vcomments"></div></div></section><footer class="about condensed"><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></footer></main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-159368053-1"></script><script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159368053-1');
    </script></body></html>