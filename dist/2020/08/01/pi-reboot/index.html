<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="google-site-verification" content="zrVlHARQzSGPX8n0jKJdP_fCO0AvtLXxoPmYkJh-oXw"/><meta name="description" content="Act local, think global with DotIN13!"><meta name="keywords" content="Raspberry Pi, Linux, and SysRq"><meta name="theme-color" content="#ff94c2"><meta lang="zh"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png?v=2bA3g2vyYK"><link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg?v=2bA3g2vyYK" color="#dc2267"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico?v=2bA3g2vyYK"><meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml?v=2bA3g2vyYK"><meta property="og:title" content="如何安全重启树莓派 - DOTIN13'S BLOG"><meta property="og:type" content="article"><meta property="og:description" content="失败使人成长 自从购入树莓派，已经被我用坏了两张MicroSD卡。 树莓派总是在我意想不到的时候停止响应，SSH访问时抛出无力的No route to host错误。当我愤怒地拔掉电源，准备重启时，却发现再也开不了机——文件系统损坏。依照网络上修复存储介质的方法，使用fsck命令无果，格式化后，当我辛辛苦苦重新安装上所有软件，准备重启，却发现又发生了掉盘，根本无法重启——这张卡算是报废了..."><meta property="article:published_time" content="2020-08-01T00:00:00Z"><meta property="article:author" content="DotIN13"><meta property="article:tag" content="Raspberry Pi"><meta property="article:tag" content="Linux"><meta property="article:tag" content="SysRq"><meta property="og:image" content="https://www.wannaexpresso.com/assets/img/orange.webp"><meta property="og:url" content="https://www.wannaexpresso.com/2020/08/01/pi-reboot/"><meta property="og:site_name" content="DOTIN13'S BLOG"><link rel="canonical" href="https://www.wannaexpresso.com/2020/08/01/pi-reboot/"><script src="/assets/public/application-bundle.js"></script><link rel="stylesheet" href="/assets/public/application.css"><script src="/assets/public/posts-bundle.js"></script><title>如何安全重启树莓派 - DOTIN13'S BLOG</title></head><body><main class="container"><section class="about"><div class="about-header"><div class="about-title"><a href="/" id="avatar" data-caption="DotIN13" data-webpack="true" data-path="/assets/img/orange.webp"></a><h2 id="title"><a href="/">DotIN13</a></h2></div><p class="tagline">LACKAWANNA<br>EXPRESSO</p></div><div class="buttons"><a href="/en-us/" class="language-selection button icon-translate" aria-label="Change locale to English."></a><a href="/feed.xml" class="feed button icon-rss_feed" aria-label="RSS Feed"></a><input type="checkbox" class="dark-mode-toggle" aria-label="dark-mode-switch"><a href="#" aria-label="Click to toggle darkmode." class="button"><span class="icon-moon"></span><span class="icon-sun"></span></a><a href="#" id="pwa-install" class="install button icon-install disabled" aria-label="Install as Web Application"><span>Install</span></a></div><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></section><section class="content"><div class="post-container"><a class="post-link" href="/2020/08/01/pi-reboot/"><h2 class="post-title">如何安全重启树莓派</h2><h3 class="post-subtitle">How To Safely Turn Off Your Raspberry Pi</h3></a><div class="post-meta"><div class="post-categories"><a class="button" href="/archive/?tag=Raspberry+Pi" title="Raspberry Pi">Raspberry Pi</a><a class="button" href="/archive/?tag=Linux" title="Linux">Linux</a><a class="button" href="/archive/?tag=SysRq" title="SysRq">SysRq</a></div><div class="post-misc"><div class="post-date"><i class="icon-calendar"></i>Aug 1, 2020</div></div></div><div class="post"><h2 id="失败使人成长"><a href="#失败使人成长">#</a> 失败使人成长 </h2><p>自从购入树莓派，已经被我用坏了两张MicroSD卡。</p><p>树莓派总是在我意想不到的时候停止响应，SSH访问时抛出无力的<code class="language-plaintext highlighter-rouge">No route to host</code>错误。当我愤怒地拔掉电源，准备重启时，却发现再也开不了机——文件系统损坏。依照网络上修复存储介质的方法，使用fsck命令无果，格式化后，当我辛辛苦苦重新安装上所有软件，准备重启，却发现又发生了掉盘，根本无法重启——这张卡算是报废了。</p><h2 id="正确地重启树莓派"><a href="#正确地重启树莓派">#</a> 正确地重启树莓派 </h2><p>不是说一张SD卡值多少钱，而是在重新刷入系统后，又需要大量的时间配置新的系统，在还没有研究出怎样完全备份系统之前，正确重启树莓派，尤其是在系统不响应时正确重启树莓派，显得尤为重要。</p><p>什么是正确的关机姿势？事实上，主要问题在于，系统中的后台程序会不断进行数据存取，尤其是在使用Aria2下载的时候，直接断电会导致内存中的数据与磁盘的数据不匹配，例如一次没有完成的写入操作很可能会产生数据块的损坏。</p><blockquote><p>Most common causes of file system corruption are due to improper shutdown or startup procedures, hardware failures, or NFS write errors. Shutdown should be done through one of the system shutdown commands; these sync the file system first. Never shut the system down by turning off the power. Taking a mounted file system off-line or physically write-protecting a mounted file system can also corrupt the disk. Improper startup includes not checking a file system for consistencies (fsck) before mounting it and not repairing any inconsistencies discovered by fsck. Hardware failures could be a bad block on disk, a bad disk controller, a power outage, or accidental unplugging of the system. Software errors in the kernel can also cause file system corruption.</p><p>Source: <a href="https://www2.cs.duke.edu/csl/docs/sysadmin_course/sysadm-80.html" target="_blank" rel="nofollow noopener noreferrer">Duke Sysadmin Course</a></p></blockquote><p>一次正确的重启意味着告诉所有应用停止运行，停止向文件系统写入，并且与文件系统同步所有还未同步的操作。要在不响应的Unix系统中做到这一点，一种显而易见的方式是让某个daemon运行重启的终端命令，另一种是使用Kernel底层的SysRq命令。</p><h2 id="基于终端命令"><a href="#基于终端命令">#</a> 基于终端命令 </h2><p>最简单的关机命令是<code class="language-plaintext highlighter-rouge">sudo shutdown -h now</code>与<code class="language-plaintext highlighter-rouge">sudo poweroff</code>，最简单的重启命令是<code class="language-plaintext highlighter-rouge">sudo reboot</code>。这几项命令都是安全的，这意味着他们不会损坏文件系统。</p><p>那么要在系统不响应的情况下使用这几个命令，思路就是事先建立一个监听某些输入的后台程序，当该程序被触发，则自动运行上述的命令。</p><p>聪明的地球人已经发明出了以下一连串基于此原理的解决方案：</p><ul><li>官方的<a href="https://www.raspberrypi.org/magpi/off-switch-raspberry-pi/" target="_blank" rel="nofollow noopener noreferrer">关机按钮</a></li><li><a href="https://www.techradar.com/how-to/how-to-control-the-raspberry-pi-with-your-voice" target="_blank" rel="nofollow noopener noreferrer">语音命令</a></li><li><a href="https://www.recantha.co.uk/blog/?p=13999" target="_blank" rel="nofollow noopener noreferrer">短接GPIO</a></li></ul><p>而我采用的就是第三种方案，因为…不需要添置任何新设备！</p><p>使用起来非常方便，首先克隆git仓库<code class="language-plaintext highlighter-rouge">git clone https://github.com/adafruit/Adafruit-GPIO-Halt</code>，然后进行编译：</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>Adafruit-GPIO-Halt
make
<span class="nb">sudo </span>make <span class="nb">install</span>
</code></pre></div></div><p>创建一个新的systemd service。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /lib/systemd/system/gpio-halt.service
</code></pre></div></div><p>使用以下内容编辑service文件。</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Short pins 21 and ground to shutdown the Pi
<span class="nv">After</span><span class="o">=</span>multi-user.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>idle
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/gpio-halt 21 &amp;

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div><p>用以下命令启动服务。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl daemon-reload
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>gpio-halt.service
<span class="nb">sudo </span>systemctl start gpio-halt.service
<span class="nb">sudo </span>systemctl status gpio-halt.service <span class="c">#查看运行情况</span>
</code></pre></div></div><p>如果你的Pi是26针，则短接GPIO7和GND，如果和我一样是40针的Pi 4B，则短接GPIO21和GND。用小钥匙碰一下，就可以轻松、安全地重启树莓派！</p><div class="post-img"><a href="/assets/img/in-post/post-pi-reboot/raspberry_pi_gpio-shutdown-pins.png" data-fancybox="gallery" data-caption="Pi GPIO Pins" data-path="post-pi-reboot/raspberry_pi_gpio-shutdown-pins.png" data-webpack="true"></a><em>Pi GPIO Pins</em></div><blockquote><p>如果你在使用我分享的<a href="/2020/07/08/pi-fan-control/">温控系统</a>，记得将温控的针脚设置为GPIO21以外的GPIO，否则风扇停转时，Pi便会重启。</p></blockquote><h2 id="基于sysrq"><a href="#基于sysrq">#</a> 基于SysRq </h2><p>另一个方案就是使用神奇的SysRq按键（<a href="https://en.wikipedia.org/wiki/Magic_SysRq_key" target="_blank" rel="nofollow noopener noreferrer">Magic SysRq Keys</a>）是一套Linux内核能够理解的按键组合，能够帮助用户执行一系列底层操作，例如关闭所有服务、重启等。具体的按键是<code class="language-plaintext highlighter-rouge">Alt+SysRq/PrintScr+功能键</code>，在按下功能键时另两个按键不能松开。</p><p>SysRq的使用前提有二：</p><ol><li>Kernel仍在运行</li><li>能够连接键盘</li></ol><p>一个常见的SysRq使用场景就是安全地重启不响应的Unix系统。这一系列按键组合被称为<code class="language-plaintext highlighter-rouge">REISUB</code>，也就是按照顺序使用这六个功能键，达到安全重启的目的。</p><ul><li>un<code class="language-plaintext highlighter-rouge">R</code>aw，从X（图形界面）处取回键盘的控制权</li><li>t<code class="language-plaintext highlighter-rouge">E</code>rminate，向所有进程发送<code class="language-plaintext highlighter-rouge">SIGTERM</code>，以让他们安全地停止运行</li><li>k<code class="language-plaintext highlighter-rouge">I</code>ll，向除了<code class="language-plaintext highlighter-rouge">init</code>的所有进程发送<code class="language-plaintext highlighter-rouge">SIGKILL</code>，强制关闭还没有关闭的进程</li><li><code class="language-plaintext highlighter-rouge">S</code>ync，将内存数据与文件系统同步</li><li><code class="language-plaintext highlighter-rouge">U</code>nmount，安全卸载文件系统</li><li>re<code class="language-plaintext highlighter-rouge">B</code>oot，重启系统</li></ul><p>连接键盘依次按下组合键，同样可以达到安全重启的目的。</p><h2 id="数据无价"><a href="#数据无价">#</a> 数据无价 </h2><p>数据无价，且用且珍惜。</p></div><ul class="post-pager"><li class="pager--next"><a class="button" href="/2020/08/14/rails-development-4/" data-toggle="tooltip" data-placement="top" title="RoR开发日志四"> NEXT<br><span>RoR开发日志四</span></a></li><li class="pager--prev"><a class="button" href="/2020/07/08/pi-fan-control/" data-toggle="tooltip" data-placement="top" title="树莓派自动风扇控制系统"> PREV<br><span>树莓派自动风扇控制系统</span></a></li></ul><div id="vcomments"></div></div></section><footer class="about condensed"><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></footer></main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-159368053-1"></script><script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159368053-1');
    </script></body></html>