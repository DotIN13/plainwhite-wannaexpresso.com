<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="google-site-verification" content="zrVlHARQzSGPX8n0jKJdP_fCO0AvtLXxoPmYkJh-oXw"/><meta name="description" content="Act local, think global with DotIN13!"><meta name="keywords" content="Linux, Ruby, Ruby on Rails, and WoD"><meta name="theme-color" content="#ff94c2"><meta lang="zh"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png?v=2bA3g2vyYK"><link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg?v=2bA3g2vyYK" color="#dc2267"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico?v=2bA3g2vyYK"><meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml?v=2bA3g2vyYK"><meta property="og:title" content="RoR开发日志四 - DOTIN13'S BLOG"><meta property="og:type" content="article"><meta property="og:description" content="未竟之业 学期结束，满目B+，也不是说开发HoE多大程度上影响了学习，只是觉得心里少了些什么东西，一时间对继续开发失了兴趣。暑假开始，便用剧集与游戏麻木自己的神经。不知是谁用指头点醒了我？不知是何处来的风吹散了遮眼尘烟？某一天从床上醒来，发现自己过去的一个月，一事无成。多少的电视剧烂了尾，多少游戏永远上不去的分，何必当真？ 重拾 于是，重拾未竟之业，尝试寻找自己对自己的一种认可。..."><meta property="article:published_time" content="2020-08-14T00:00:00Z"><meta property="article:author" content="DotIN13"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Ruby"><meta property="article:tag" content="Ruby on Rails"><meta property="article:tag" content="WoD"><meta property="og:image" content="https://www.wannaexpresso.com/assets/img/orange.webp"><meta property="og:url" content="https://www.wannaexpresso.com/2020/08/14/rails-development-4/"><meta property="og:site_name" content="DOTIN13'S BLOG"><link rel="canonical" href="https://www.wannaexpresso.com/2020/08/14/rails-development-4/"><script src="/assets/public/application-bundle.js"></script><link rel="stylesheet" href="/assets/public/application.css"><script src="/assets/public/posts-bundle.js"></script><title>RoR开发日志四 - DOTIN13'S BLOG</title></head><body><main class="container"><section class="about"><div class="about-header"><div class="about-title"><a href="/" id="avatar" data-caption="DotIN13" data-webpack="true" data-path="/assets/img/orange.webp"></a><h2 id="title"><a href="/">DotIN13</a></h2></div><p class="tagline">LACKAWANNA<br>EXPRESSO</p></div><div class="buttons"><a href="/en-us/" class="language-selection button icon-translate" aria-label="Change locale to English."></a><a href="/feed.xml" class="feed button icon-rss_feed" aria-label="RSS Feed"></a><input type="checkbox" class="dark-mode-toggle" aria-label="dark-mode-switch"><a href="#" aria-label="Click to toggle darkmode." class="button"><span class="icon-moon"></span><span class="icon-sun"></span></a><a href="#" id="pwa-install" class="install button icon-install disabled" aria-label="Install as Web Application"><span>Install</span></a></div><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></section><section class="content"><div class="post-container"><a class="post-link" href="/2020/08/14/rails-development-4/"><h2 class="post-title">RoR开发日志四</h2><h3 class="post-subtitle">Ruby on Rails Development Log Four</h3></a><div class="post-meta"><div class="post-categories"><a class="button" href="/archive/?tag=Linux" title="Linux">Linux</a><a class="button" href="/archive/?tag=Ruby" title="Ruby">Ruby</a><a class="button" href="/archive/?tag=Ruby+on+Rails" title="Ruby on Rails">Ruby on Rails</a><a class="button" href="/archive/?tag=WoD" title="WoD">WoD</a></div><div class="post-misc"><div class="post-date"><i class="icon-calendar"></i>Aug 14, 2020</div></div></div><div class="post"><h2 id="未竟之业"><a href="#未竟之业">#</a> 未竟之业 </h2><p>学期结束，满目B+，也不是说开发HoE多大程度上影响了学习，只是觉得心里少了些什么东西，一时间对继续开发失了兴趣。暑假开始，便用剧集与游戏麻木自己的神经。不知是谁用指头点醒了我？不知是何处来的风吹散了遮眼尘烟？某一天从床上醒来，发现自己过去的一个月，一事无成。多少的电视剧烂了尾，多少游戏永远上不去的分，何必当真？</p><div class="post-img"><a href="/assets/img/in-post/post-rails-development/reminiscence.png" data-fancybox="gallery" data-caption="重拾" data-path="post-rails-development/reminiscence.png" data-webpack="true"></a><em>重拾</em></div><p>于是，重拾未竟之业，尝试寻找自己对自己的一种认可。</p><h2 id="本地调试postgresql"><a href="#本地调试postgresql">#</a> 本地调试PostgreSQL </h2><p>开发许久，终于意识到将游戏配置存在数据库中是多大的一个relief。于是决定将英雄属性列表、攻击类型列表一类游戏核心配置全部存进一张表里。数据类型，要不就用数组吧。不过Rails自带的SQLite并不能支持原生的Array，与我在production环境中所用的PostgreSQL不一。于是决定在本地建立一个psql用作调试。</p><p>检查软件列表，发现12.3的PostgreSQL不知何时已然装好，于是尝试运行<code class="language-plaintext highlighter-rouge">postgres</code>命令，却发现报错，表示必须要使用单独的用户来运行postgres相关命令，以保证数据的安全。由于尚在摸索中，不当心用<code class="language-plaintext highlighter-rouge">userdel</code>删除了安装PostgreSQL时自动创建的<code class="language-plaintext highlighter-rouge">postgres</code>用户。也罢，只得自己再创建一个新的。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>useradd <span class="nt">-m</span> <span class="nt">-d</span> /var/lib/pgsql
<span class="nb">sudo chown</span> <span class="nt">-R</span> postgres:postgres /var/lib/pgsql
</code></pre></div></div><p>依照<a href="https://www.postgresql.org/docs/current/creating-cluster.html" target="_blank" rel="nofollow noopener noreferrer">PostgreSQL Documentation</a>，我把postgres用户的home目录设置到了<code class="language-plaintext highlighter-rouge">/var/lib</code>，没学过Unix文件结构，姑且这么干了。然后切换到新用户，创建数据库文件。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-i</span> <span class="nt">-u</span> postgres <span class="c"># 切换到postgres用户</span>
<span class="nb">mkdir</span> /var/lib/pgsql/data
initdb <span class="nt">-D</span> /var/lib/pgsql/data <span class="c"># 创建数据库文件</span>
</code></pre></div></div><p>我试图直接运行<code class="language-plaintext highlighter-rouge">pg_ctl</code>开启服务器，缺发现缺少对<code class="language-plaintext highlighter-rouge">/run/postgresql</code>的权限。于是只好创建文件夹并赋予<code class="language-plaintext highlighter-rouge">postgres</code>相应权限。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Error: "/run/postgresql/.s.PGSQL.5432.lock": No such file or directory</span>
<span class="nb">sudo mkdir</span> /run/postgresql
<span class="nb">sudo chown</span> <span class="nt">-R</span> postgres:postgres /run/postgresql
</code></pre></div></div><p>此时<code class="language-plaintext highlighter-rouge">pg_ctl start -l logfile -D /var/lib/pgsql/data</code>就可以非常合理地启动服务器了。</p><p>我还为pg_ctl配置了systemd的开机自启，方便调试。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/systemd/system/postgresql.service</span>
<span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>PostgreSQL database server
<span class="nv">Documentation</span><span class="o">=</span>man:postgres<span class="o">(</span>1<span class="o">)</span>

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">User</span><span class="o">=</span>postgres
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/postgres <span class="nt">-D</span> /var/lib/pgsql/data
<span class="nv">ExecReload</span><span class="o">=</span>/bin/kill <span class="nt">-HUP</span> <span class="nv">$MAINPID</span>
<span class="nv">KillMode</span><span class="o">=</span>mixed
<span class="nv">KillSignal</span><span class="o">=</span>SIGINT
<span class="nv">TimeoutSec</span><span class="o">=</span>0

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div><p>然后就是配置Rails了。</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/database.yml</span>
<span class="na">default</span><span class="pi">:</span> <span class="nl">&amp;default</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">postgresql</span>
  <span class="na">encoding</span><span class="pi">:</span> <span class="s">unicode</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">postgres</span>
  <span class="na">pool</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">timeout</span><span class="pi">:</span> <span class="m">5000</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">localhost</span>

<span class="na">development</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">ezantoh-development</span>

<span class="c1"># Warning: The database defined as "test" will be erased and</span>
<span class="c1"># re-generated from your development database when you run "rake".</span>
<span class="c1"># Do not set this db to the same as development or production.</span>
<span class="na">test</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">ezantoh-test</span>

<span class="na">production</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="c1"># database: db/production.sqlite3</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">postgresql</span>
  <span class="na">encoding</span><span class="pi">:</span> <span class="s">unicode</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">&lt;%= ENV['RDS_DATABASE'] %&gt;</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">&lt;%= ENV['RDS_USERNAME'] %&gt;</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['RDS_PASSWORD'] %&gt;</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">&lt;%= ENV['RDS_HOST'] %&gt;</span>
  <span class="na">post</span><span class="pi">:</span> <span class="m">5432</span>
</code></pre></div></div><p>最后收尾，运行<code class="language-plaintext highlighter-rouge">rails db:setup</code>就可以建立development和test所需的数据库了。</p><p>可以用pgAdmin GUI方便地查看刚刚建立的数据库。</p><blockquote><p>友情提示：如果<code class="language-plaintext highlighter-rouge">rails console</code>还没反应过来，还在使用SQLite，那么就需要运行<code class="language-plaintext highlighter-rouge">bin/spring stop</code>来点醒他了。</p></blockquote><p>如此一来，我在本地和AWS上的数据库就能保持统一，做到同步使用<code class="language-plaintext highlighter-rouge">array: true</code>了。</p><h2 id="数组表单"><a href="#数组表单">#</a> 数组表单 </h2><p>数据库的部分完成之后，就要考虑怎么创建表单了。</p><p>阅读<a href="https://guides.rubyonrails.org/form_helpers.html#basic-structures" target="_blank" rel="nofollow noopener noreferrer">Rails Guides Form Helpers</a>，我了解到使用形如<code class="language-plaintext highlighter-rouge">game_rule[value][]</code>的name就可以使params获取到数组。例如：</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"person[phone_number][]"</span> <span class="na">value=</span><span class="s">"0"</span> <span class="na">type=</span><span class="s">"text"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"person[phone_number][]"</span> <span class="na">value=</span><span class="s">"0"</span> <span class="na">type=</span><span class="s">"text"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"person[phone_number][]"</span> <span class="na">value=</span><span class="s">"0"</span> <span class="na">type=</span><span class="s">"text"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>这样的三个输入框会形成一个如下的params：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="s1">'person'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">'phone_number'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'0'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div></div><p>但Rails原生没有合适的helper可以创建这样的表单，在不断的尝试下，终于找到了一个折中的方案，同时满足了新建与修改两个action的需求。</p><div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="p">(</span><span class="n">person</span><span class="p">.</span><span class="nf">phone_number</span> <span class="o">||</span> <span class="p">[</span><span class="kp">nil</span><span class="p">]).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field form-group col-6 col-md-3"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:value</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">text_field_tag</span> <span class="s1">'person[phone_number][]'</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"form-control"</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div><h2 id="根据字符串定义方法"><a href="#根据字符串定义方法">#</a> 根据字符串定义方法 </h2><p>在创建游戏配置的时候，想要批量定义多个方法，于是便从万能的<code class="language-plaintext highlighter-rouge">StackOverflow</code>了解，可以利用字符串数组来批量<code class="language-plaintext highlighter-rouge">define_method</code>。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo</span>
  <span class="sx">%w[method_a method_b]</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">method_name</span><span class="o">|</span>
    <span class="n">define_method</span> <span class="n">method_name</span> <span class="k">do</span> <span class="o">|</span><span class="n">args</span><span class="o">|</span>
      <span class="c1"># Do something</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div><p>如此一来就建立了<code class="language-plaintext highlighter-rouge">#method_a(arg)</code>和<code class="language-plaintext highlighter-rouge">#method_b(arg)</code>两个instance method。那么想要建立class method的话，只需要调用<code class="language-plaintext highlighter-rouge">self.class.defind_method</code>即可，例如：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo</span>
  <span class="sx">%w[method_a method_b]</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">method_name</span><span class="o">|</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">define_method</span> <span class="n">method_name</span> <span class="k">do</span> <span class="o">|</span><span class="n">args</span><span class="o">|</span>
      <span class="c1"># Do something</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div><h2 id="总结"><a href="#总结">#</a> 总结 </h2><p>不断地学习，不断地成长，不要对结果抱有太多的胜负心，享受过程。</p></div><ul class="post-pager"><li class="pager--next"><a class="button" href="/2020/09/01/rails-development-5/" data-toggle="tooltip" data-placement="top" title="RoR开发日志五"> NEXT<br><span>RoR开发日志五</span></a></li><li class="pager--prev"><a class="button" href="/2020/08/01/pi-reboot/" data-toggle="tooltip" data-placement="top" title="如何安全重启树莓派"> PREV<br><span>如何安全重启树莓派</span></a></li></ul><div id="vcomments"></div></div></section><footer class="about condensed"><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></footer></main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-159368053-1"></script><script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159368053-1');
    </script></body></html>