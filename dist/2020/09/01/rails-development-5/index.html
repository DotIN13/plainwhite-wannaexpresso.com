<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="google-site-verification" content="zrVlHARQzSGPX8n0jKJdP_fCO0AvtLXxoPmYkJh-oXw"/><meta name="description" content="Act local, think global with DotIN13!"><meta name="keywords" content="Linux, Ruby, Ruby on Rails, and WoD"><meta name="theme-color" content="#ff94c2"><meta lang="zh"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png?v=2bA3g2vyYK"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png?v=2bA3g2vyYK"><link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg?v=2bA3g2vyYK" color="#dc2267"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico?v=2bA3g2vyYK"><meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/img/favicon/browserconfig.xml?v=2bA3g2vyYK"><meta property="og:title" content="RoR开发日志五 - DOTIN13'S BLOG"><meta property="og:type" content="article"><meta property="og:description" content="Development must go on… 前几日观摩Web Dev，与会嘉宾口若悬河，称道自己两天内写了两千行代码，还故作谦虚，惊诧之余，暗暗感叹自己边学边写，速度实在有如龟行。一段代码，改了又改，改了又改，遇到难写处，我便喜欢起身倒水，一天能喝上十数杯。倒也不是企图从杯水中得些什么灵感，只不过是给自己僵住的大脑来上那么点distraction罢了。话虽然这么说，不断的refacto..."><meta property="article:published_time" content="2020-09-01T00:00:00Z"><meta property="article:author" content="DotIN13"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Ruby"><meta property="article:tag" content="Ruby on Rails"><meta property="article:tag" content="WoD"><meta property="og:image" content="https://www.wannaexpresso.com/assets/img/orange.webp"><meta property="og:url" content="https://www.wannaexpresso.com/2020/09/01/rails-development-5/"><meta property="og:site_name" content="DOTIN13'S BLOG"><link rel="canonical" href="https://www.wannaexpresso.com/2020/09/01/rails-development-5/"><script src="/assets/public/application-bundle.js"></script><link rel="stylesheet" href="/assets/public/application.css"><script src="/assets/public/posts-bundle.js"></script><title>RoR开发日志五 - DOTIN13'S BLOG</title></head><body><main class="container"><section class="about"><div class="about-header"><div class="about-title"><a href="/" id="avatar" data-caption="DotIN13" data-webpack="true" data-path="/assets/img/orange.webp"></a><h2 id="title"><a href="/">DotIN13</a></h2></div><p class="tagline">LACKAWANNA<br>EXPRESSO</p></div><div class="buttons"><a href="/en-us/" class="language-selection button icon-translate" aria-label="Change locale to English."></a><a href="/feed.xml" class="feed button icon-rss_feed" aria-label="RSS Feed"></a><input type="checkbox" class="dark-mode-toggle" aria-label="dark-mode-switch"><a href="#" aria-label="Click to toggle darkmode." class="button"><span class="icon-moon"></span><span class="icon-sun"></span></a><a href="#" id="pwa-install" class="install button icon-install disabled" aria-label="Install as Web Application"><span>Install</span></a></div><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></section><section class="content"><div class="post-container"><a class="post-link" href="/2020/09/01/rails-development-5/"><h2 class="post-title">RoR开发日志五</h2><h3 class="post-subtitle">Ruby on Rails Development Log Five</h3></a><div class="post-meta"><div class="post-categories"><a class="button" href="/archive/?tag=Linux" title="Linux">Linux</a><a class="button" href="/archive/?tag=Ruby" title="Ruby">Ruby</a><a class="button" href="/archive/?tag=Ruby+on+Rails" title="Ruby on Rails">Ruby on Rails</a><a class="button" href="/archive/?tag=WoD" title="WoD">WoD</a></div><div class="post-misc"><div class="post-date"><i class="icon-calendar"></i>Sep 1, 2020</div></div></div><div class="post"><h2 id="development-must-go-on"><a href="#development-must-go-on">#</a> Development must go on… </h2><p>前几日观摩Web Dev，与会嘉宾口若悬河，称道自己两天内写了两千行代码，还故作谦虚，惊诧之余，暗暗感叹自己边学边写，速度实在有如龟行。一段代码，改了又改，改了又改，遇到难写处，我便喜欢起身倒水，一天能喝上十数杯。倒也不是企图从杯水中得些什么灵感，只不过是给自己僵住的大脑来上那么点distraction罢了。话虽然这么说，不断的refactoring确确实实相当痛苦，但最终看到自己的新设想得到实现，心中总有那么一点说不出的喜。</p><p>有时会对自己说，万一真的遇到我和我的老伙计——<code class="language-plaintext highlighter-rouge">StackOverflow</code>都解决不了的问题该怎么办。说真的，我还确实没怎么想过这个问题，不过也许那时候，我还可以请教我的朋友，我还可以一遍一遍地去思索。有人说要用有限的生命去做无限的为人民服务，我倒是想说，我或许会用无限的时间去解决那么几个有限的问题，如果我告诉你这是勇于追寻真理，那么朋友，或许你应该点醒我：那是因为当下你有的，除了时间，还是时间。</p><h2 id="全局logger"><a href="#全局logger">#</a> 全局Logger </h2><p>我正在制作的战斗系统包括战场、人员两大主要的对象，我的目标是在任何地方使用日志时，都能获取到同一个日志变量，并对战斗进行记录。似乎在类与类之间没法做到这一点，不过凑巧的是<a href="https://stackoverflow.com/questions/917566/ruby-share-logger-instance-among-module-classes" target="_blank" rel="nofollow noopener noreferrer">StackOverflow</a>上已经有了靠谱的解决方法——Module。</p><p>有趣之处在于，在将Module包含到Class中时，Instance methods会被加载到Class中，而Module中的Class methods（事实上并不存在Module methods，他们应该被叫做Class methods）仍然可以直接在Module上直接调用。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Foo</span>
  <span class="c1"># Instance method of module Foo</span>
  <span class="k">def</span> <span class="nf">method_a</span>
    <span class="nb">puts</span> <span class="s2">"a"</span>
  <span class="k">end</span>

  <span class="c1"># Class method of module Foo</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">method_b</span>
    <span class="nb">puts</span> <span class="s2">"b"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Bar</span>
  <span class="kp">include</span> <span class="no">Foo</span>
<span class="k">end</span>
</code></pre></div></div><p>上面的例子中，运行以下代码会有如下的输出。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">bar</span> <span class="o">=</span> <span class="no">Bar</span><span class="p">.</span><span class="nf">new</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">002</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">bar</span><span class="p">.</span><span class="nf">method_a</span>
<span class="c1"># =&gt; a</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">003</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">bar</span><span class="p">.</span><span class="nf">method_b</span>
<span class="c1"># =&gt; undefined method `method_b' for #&lt;Bar:0x000055ac39b5d020&gt;</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">004</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;</span> <span class="no">Bar</span><span class="p">.</span><span class="nf">method_b</span>
<span class="c1"># =&gt; undefined method `method_b' for #&lt;Bar: Class&gt;</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">004</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;</span> <span class="no">Foo</span><span class="p">.</span><span class="nf">method_b</span>
<span class="c1"># =&gt; b</span>
</code></pre></div></div><p>可见，Module中的Class Methods不会被添加到include该Module的Class中，仍然可以正常对Module调用，而这些Class Methods中的Class Variable也相应的可以留存在Module中，从而可以通过<code class="language-plaintext highlighter-rouge">Module.accessor_method</code>顺利地读写。如此以来，以下的写法就可以让我们在多个Class中用同样的方法来读写同一个变量了：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Logging</span>
  <span class="k">def</span> <span class="nf">logger</span>
    <span class="no">Logging</span><span class="p">.</span><span class="nf">logger</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">logger</span>
    <span class="vi">@logger</span> <span class="o">||=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Battlefield</span>
  <span class="kp">include</span> <span class="no">Logging</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Combatant</span>
  <span class="kp">include</span> <span class="no">Logging</span>
<span class="k">end</span>
</code></pre></div></div><p>如此一来，两个类中的<code class="language-plaintext highlighter-rouge">#logger</code>方法便都指向了<code class="language-plaintext highlighter-rouge">Logging.logger</code>，而后者正是Module Logging中的<code class="language-plaintext highlighter-rouge">@logger</code>。简单的说，我们可以在两个类中操作同一个<code class="language-plaintext highlighter-rouge">@logger</code>了。</p><p>上面的代码还可以用<a href="https://ruby-doc.org/core-2.7.1/doc/syntax/modules_and_classes_rdoc.html#label-Singleton+Classes" target="_blank" rel="nofollow noopener noreferrer">Skeleton Class</a>的写法<code class="language-plaintext highlighter-rouge">class &lt;&lt; self</code>来改写：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Logging</span>
  <span class="c1"># 相当于定义了self.logger与self.logger=两个accessor</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="nb">attr_accessor</span> <span class="ss">:logger</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">logger</span>
    <span class="no">Logging</span><span class="p">.</span><span class="nf">logger</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">logger</span><span class="o">=</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
    <span class="no">Logging</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="n">logger</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div><p>这个办法不仅仅可以用来读写日志，在我的实践中，我还用他记录战斗的回合数，相信他还有更多的妙用，等你去发现。</p><h2 id="控制器名称"><a href="#控制器名称">#</a> 控制器名称 </h2><p>我知道给View加上太多logic是不合理的，不过有的时候还是想这么干，比如只有在技能的View里才显示增益效果的表单。这时候可以读取resource的<code class="language-plaintext highlighter-rouge">class.name</code>，不过我还是做了做功课，看了看有没有更好的办法。</p><p>结果是，并没有，不过<a href="https://stackoverflow.com/questions/3757491/can-i-get-the-name-of-the-current-controller-in-the-view" target="_blank" rel="nofollow noopener noreferrer">热心的网友</a>告诉我，也可以用Controller的名称来辨别。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">controller</span><span class="p">.</span><span class="nf">controller_name</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">controller.controller_name</code>包含了当前控制器的名称，例如你的控制器叫<code class="language-plaintext highlighter-rouge">SkillsController</code>，那么这一方法的返回值就是字符串<code class="language-plaintext highlighter-rouge">skills</code>。配合判断语句，可以在不用到resource的情况下判断当前View的位置。</p><h2 id="custom-seeding"><a href="#custom-seeding">#</a> Custom Seeding </h2><p>上次问我的攻城狮朋友，该怎么处理游戏的基础数据，例如升级所需经验、英雄属性的种类，他告诉我存数据库方便修改。一开始我并不确信，不过在几个月的实践之后，我发现似乎确实如此，当你想添加一个属性，一种技能类型的时候，如果你没有把他们存在一个地方，那么这一次refactoring将让你难忘至少半个月。</p><p>问题就在于，Development和Production并不共用数据库，这意味着我把基础数据存进开发数据库后，我还得手动到Production创建另一份，况且我把这些基础数据用来作了Enum，如果这些数据不存在，服务器甚至没法启动，这时候只能用Seed来代劳了。但Seed文件只能有<code class="language-plaintext highlighter-rouge">db/seeds.rb</code>一个，想要分模块导入数据应该怎么做呢？</p><p>万能的<a href="https://stackoverflow.com/questions/7130334/is-there-any-way-to-have-multiple-seeds-rb-files-any-kind-of-versioning-for-s" target="_blank" rel="nofollow noopener noreferrer">Stacky</a>告诉了我一个完美的方案，只消建立一个Rake task！</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lib/tasks/custom_seed.rake</span>
<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:seed</span> <span class="k">do</span>

    <span class="no">Dir</span><span class="p">[</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">,</span> <span class="s1">'db'</span><span class="p">,</span> <span class="s1">'seeds'</span><span class="p">,</span> <span class="s1">'*.rb'</span><span class="p">)].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
      <span class="n">task_name</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'.rb'</span><span class="p">).</span><span class="nf">intern</span>

      <span class="n">task</span> <span class="n">task_name</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
        <span class="nb">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:all</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
      <span class="no">Dir</span><span class="p">[</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">,</span> <span class="s1">'db'</span><span class="p">,</span> <span class="s1">'seeds'</span><span class="p">,</span> <span class="s1">'*.rb'</span><span class="p">)].</span><span class="nf">sort</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
        <span class="nb">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div><p>创建Rake task之后，我把我的多个Seed文件放到<code class="language-plaintext highlighter-rouge">db/seeds</code>文件夹下，如此一来，只要用<code class="language-plaintext highlighter-rouge">rails db:seed:file_name</code>就可以Seed一个单独的文件，而不必将整个<code class="language-plaintext highlighter-rouge">db/seeds.rb</code>都更新到数据库中了。</p><p>而<code class="language-plaintext highlighter-rouge">rails db:seed:all</code>则会导入整个<code class="language-plaintext highlighter-rouge">db/seeds</code>文件夹中的Seed。</p><p>另一个值得一提的地方是，Rails的<code class="language-plaintext highlighter-rouge">find_or_create_by</code>方法让更新基础数据非常方便。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Game</span><span class="p">.</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"initial_experience"</span><span class="p">).</span><span class="nf">update</span><span class="p">(</span><span class="ss">value: </span><span class="mi">100000</span><span class="p">)</span>
</code></pre></div></div><p>这样的Seed可以在没有找到条目的时候自动创建，而如果条目已经存在时则直接更新，相当人性化。</p><h2 id="时间"><a href="#时间">#</a> 时间 </h2><p>我有的是时间吗？似乎也不尽然，开学在即，不知道此后还有多少时间供我挥霍。身边的同学不是在实习，就是在找寻工作，求索落脚之处，或许不知何时起，我也当开始珍惜，珍惜逝去的秋水。</p><p>只不过现下还可略作最后的狂欢罢了。</p></div><ul class="post-pager"><li class="pager--next"><a class="button" href="/2020/09/29/another-election/" data-toggle="tooltip" data-placement="top" title="再一次，学代会"> NEXT<br><span>再一次，学代会</span></a></li><li class="pager--prev"><a class="button" href="/2020/08/14/rails-development-4/" data-toggle="tooltip" data-placement="top" title="RoR开发日志四"> PREV<br><span>RoR开发日志四</span></a></li></ul><div id="vcomments"></div></div></section><footer class="about condensed"><ul class="social condensed"><li><a target="_blank" rel="noreferrer" href="https://github.com/DotIN13" aria-label="GitHub Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://www.facebook.com/peter.zhang.1466" aria-label="Facebook Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://twitter.com/DotIN13" aria-label="Twitter Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="fab icon-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" rel="noreferrer" href="https://space.bilibili.com/4471331" aria-label="Bilibili Social Link"><span class="fa-stack fa-2x"><i class="fas icon-circle fa-stack-2x"></i><i class="icon-bilibili fa-stack-1x fa-inverse"></i></span></a></li></ul><nav class="navigation condensed"><ul><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li></ul></nav><section class="about-footer condensed"><div><a href="https://icp.gov.moe" rel="noreferrer" target="_blank">Moe ICP </a><a href="https://icp.gov.moe/?keyword=20201620" target="_blank" rel="noreferrer">20201620</a></div><div><a rel="noreferrer" href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC-BY-SA 4.0</a></div></section></footer></main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-159368053-1"></script><script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159368053-1');
    </script></body></html>